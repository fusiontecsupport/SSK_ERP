@{
    ViewBag.Title = "Stock View Report";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    .main-container {
        background: white;
        min-height: 100vh;
        padding: 20px;
    }

    .content-wrapper {
        background: white;
        border-radius: 15px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        border: 1px solid #e9ecef;
    }

    .header-section {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
        padding: 25px 30px;
        border-radius: 15px 15px 0 0;
        position: relative;
    }

    .header-title {
        font-size: 28px;
        font-weight: 600;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 15px;
    }

    /* Date Filter Section */
    .filter-section {
        padding: 30px;
        background: linear-gradient(135deg, #f8f9ff 0%, #e8f2ff 100%);
        border-bottom: 1px solid #e9ecef;
    }

    .form-label {
        font-size: 14px;
        margin-bottom: 8px;
        font-weight: 600;
        color: #2c3e50;
    }

    .form-control {
        border-radius: 8px;
        border: 2px solid #e9ecef;
        padding: 10px 12px;
        transition: all 0.3s ease;
    }

    .form-control:focus {
        border-color: #4facfe;
        box-shadow: 0 0 0 0.2rem rgba(79, 172, 254, 0.25);
    }

    #loadDataBtn {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        border: none;
        border-radius: 8px;
        padding: 10px 20px;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    #loadDataBtn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(79, 172, 254, 0.4);
    }

    /* Tab styling - similar to packing master */
    .nav-tabs {
        border-bottom: 2px solid #dee2e6;
        margin-bottom: 20px;
    }

    .nav-tabs .nav-link {
        border: 1px solid transparent;
        border-top-left-radius: 0.5rem;
        border-top-right-radius: 0.5rem;
        color: #495057;
        font-weight: 500;
        padding: 10px 20px;
        margin-right: 5px;
        transition: all 0.3s ease;
    }

    .nav-tabs .nav-link:hover {
        border-color: #e9ecef #e9ecef #dee2e6;
        background-color: #f8f9fa;
    }

    .nav-tabs .nav-link.active {
        color: #fff;
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        border-color: #4facfe;
        font-weight: 600;
    }

    .btn-success {
        background: linear-gradient(135deg, #11998e, #38ef7d);
        border: none;
        padding: 10px 30px;
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    .btn-success:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(56, 239, 125, 0.4);
    }

    /* Tabs Section */
    .nav-tabs {
        border-bottom: 2px solid #e9ecef;
        padding: 0 30px;
        background: white;
    }

    .nav-tabs .nav-link {
        border: none;
        color: #6c757d;
        font-weight: 600;
        padding: 15px 30px;
        transition: all 0.3s ease;
    }

    .nav-tabs .nav-link.active {
        color: #4facfe;
        border-bottom: 3px solid #4facfe;
        background: transparent;
    }

    .nav-tabs .nav-link:hover {
        color: #4facfe;
    }

    /* Table Section */
    .table-container {
        padding: 30px;
        background: white;
        overflow-x: auto;
    }

    #stockReportTable {
        border-collapse: collapse;
        width: 100%;
        font-size: 13px;
    }

    #stockReportTable thead th {
        background: #7f88e9;
        color: white;
        font-weight: 600;
        padding: 12px 8px;
        text-align: center;
        border: 1px solid #6c75d3;
        white-space: nowrap;
    }

    #stockReportTable tbody td {
        padding: 8px;
        border: 1px solid #dee2e6;
        text-align: center;
    }

    #stockReportTable tbody tr.product-row {
        background: #f8f9fa;
        font-weight: 600;
    }

    #stockReportTable tbody tr.opening-stock {
        background: #e3f2fd;
    }

    #stockReportTable tbody tr.production {
        background: #fff3cd;
    }

    #stockReportTable tbody tr.total {
        background: #d4edda;
        font-weight: 600;
    }

    #stockReportTable tbody tr.rate {
        background: #f8d7da;
    }

    #stockReportTable tbody tr.amount {
        background: #d1ecf1;
    }

    .particulars-cell {
        text-align: left !important;
        padding-left: 15px !important;
        font-weight: 600;
    }

    .total-slabs {
        background: #ffc107 !important;
        font-weight: bold;
    }

    /* Export Button */
    .export-btn {
        position: absolute;
        top: 25px;
        right: 30px;
    }
</style>

<div class="main-container">
    <div class="content-wrapper">
        <!-- Header -->
        <div class="header-section" style="position: relative;">
            <h1 class="header-title">
                <i class="fa fa-chart-bar"></i>
                Stock View Report
            </h1>
            <button id="exportBtn" class="btn btn-success export-btn">
                <i class="fa fa-file-excel"></i> Export to Excel
            </button>
        </div>

        <!-- Date Filter Section -->
        <div class="filter-section">
            <div class="row">
                <div class="col-md-3">
                    <label class="form-label">From Date:</label>
                    <input type="date" id="fromDate" class="form-control" value="@DateTime.Now.AddDays(-30).ToString("yyyy-MM-dd")" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">To Date:</label>
                    <input type="date" id="toDate" class="form-control" value="@DateTime.Now.ToString("yyyy-MM-dd")" />
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button id="loadDataBtn" class="btn btn-primary">
                        <i class="fa fa-search"></i> Load Data
                    </button>
                </div>
            </div>
        </div>

        <!-- Grouped Table Section - Data by ReceivedType -->
        <div class="table-container" id="tablesContainer">
            <div style="text-align: center; margin-bottom: 20px;">
                <h6 style="margin: 5px 0;"><strong>STOCK AS ON <span id="stockDate">@DateTime.Now.ToString("dd/MM/yyyy")</span></strong></h6>
            </div>
            <div id="stockTablesWrapper">
                <!-- Data will be loaded here grouped by ReceivedType -->
                <p class="text-center">Please select dates and click "Load Data"</p>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script>
        $(document).ready(function () {
            // Load Data
            $('#loadDataBtn').on('click', function () {
                loadStockData();
            });

            // Export to Excel
            $('#exportBtn').on('click', function () {
                exportToExcel();
            });

            function loadStockData() {
                const fromDate = $('#fromDate').val();
                const toDate = $('#toDate').val();

                if (!fromDate || !toDate) {
                    alert('Please select both From and To dates');
                    return;
                }

                $.ajax({
                    url: '@Url.Action("GetStockData", "StockViewReport")',
                    type: 'POST',
                    data: {
                        fromDate: fromDate,
                        toDate: toDate,
                        tab: 'ALL'
                    },
                    success: function (response) {
                        if (response.success) {
                            renderStockTable(response.data);
                            $('#stockDate').text(new Date(toDate).toLocaleDateString('en-GB'));
                        } else {
                            alert('Error loading data: ' + response.message);
                        }
                    },
                    error: function () {
                        alert('Error loading stock data');
                    }
                });
            }

            function renderStockTable(data) {
                const wrapper = $('#stockTablesWrapper');
                wrapper.empty();

                if (!data || data.length === 0) {
                    wrapper.append('<p class="text-center">No data available</p>');
                    return;
                }

                // Group data by ReceivedType
                const groupedData = {};
                data.forEach(function(item) {
                    const receivedType = item.ReceivedType || 'Unknown';
                    if (!groupedData[receivedType]) {
                        groupedData[receivedType] = {
                            items: [],
                            columnHeaders: item.ColumnHeaders || []
                        };
                    }
                    groupedData[receivedType].items.push(item);
                });

                // Render each group as a separate table
                let groupIndex = 0;
                for (const receivedType in groupedData) {
                    const group = groupedData[receivedType];
                    const items = group.items;
                    const columnHeaders = group.columnHeaders;
                    
                    // Add section header
                    if (groupIndex > 0) {
                        wrapper.append('<div style="margin-top: 40px;"></div>');
                    }
                    wrapper.append(`
                        <div style="margin-bottom: 20px;">
                            <h5 style="color: #4facfe; font-weight: 600; border-bottom: 2px solid #4facfe; padding-bottom: 10px;">
                                <i class="fa fa-box"></i> ${receivedType}
                            </h5>
                        </div>
                    `);

                    // Create table header dynamically based on column headers
                    let headerRow = '<tr><th rowspan="2">PARTICULARS</th>';
                    columnHeaders.forEach(function(header) {
                        headerRow += `<th rowspan="2">${header}</th>`;
                    });
                    headerRow += '<th rowspan="2">TOTAL NO. OF SLABS</th></tr>';

                    // Create table for this group with dynamic headers
                    const tableHtml = `
                        <table class="table table-bordered" style="margin-bottom: 30px;">
                            <thead>
                                ${headerRow}
                            </thead>
                            <tbody class="group-tbody-${groupIndex}">
                            </tbody>
                        </table>
                    `;
                    wrapper.append(tableHtml);

                    const tbody = $(`.group-tbody-${groupIndex}`);
                    
                    // Render items for this group
                    items.forEach(function (item, index) {
                        const openingData = item.OpeningData || [];
                        const productionData = item.ProductionData || [];
                        const totalData = item.TotalData || [];
                        const colCount = columnHeaders.length;

                        // Product Row (no yellow box, merged across all columns)
                        tbody.append(`
                            <tr class="product-row">
                                <td class="particulars-cell" colspan="${colCount + 2}">${index + 1}. ${item.ProductName}</td>
                            </tr>
                        `);

                        // OPENING STOCK Row (data before fromDate) - Dynamic columns
                        let openingRow = '<tr class="opening-stock"><td class="particulars-cell">OPENING STOCK</td>';
                        for (let i = 0; i < colCount; i++) {
                            openingRow += `<td>${openingData[i] || 0}</td>`;
                        }
                        openingRow += `<td>${item.OpeningTotalSlabs || 0}</td></tr>`;
                        tbody.append(openingRow);

                        // PRODUCTION Row (data from fromDate to toDate) - Dynamic columns
                        let productionRow = '<tr class="production"><td class="particulars-cell">PRODUCTION</td>';
                        for (let i = 0; i < colCount; i++) {
                            productionRow += `<td>${productionData[i] || 0}</td>`;
                        }
                        productionRow += `<td>${item.ProductionTotalSlabs || 0}</td></tr>`;
                        tbody.append(productionRow);

                        // TOTAL Row (Opening + Production) - Dynamic columns
                        let totalRow = '<tr class="total"><td class="particulars-cell">TOTAL</td>';
                        for (let i = 0; i < colCount; i++) {
                            totalRow += `<td>${totalData[i] || 0}</td>`;
                        }
                        totalRow += `<td>${item.TotalSlabs || 0}</td></tr>`;
                        tbody.append(totalRow);

                        // RATE Row (all zeros) - Dynamic columns
                        let rateRow = '<tr class="rate"><td class="particulars-cell">RATE</td>';
                        for (let i = 0; i < colCount; i++) {
                            rateRow += '<td>0</td>';
                        }
                        rateRow += '<td>0</td></tr>';
                        tbody.append(rateRow);

                        // AMOUNT Row (all zeros) - Dynamic columns
                        let amountRow = '<tr class="amount"><td class="particulars-cell">AMOUNT</td>';
                        for (let i = 0; i < colCount; i++) {
                            amountRow += '<td>0</td>';
                        }
                        amountRow += '<td>0</td></tr>';
                        tbody.append(amountRow);
                        
                        // Add blank row for spacing between products
                        tbody.append('<tr class="spacing-row"><td colspan="' + (colCount + 2) + '" style="height: 15px; background: transparent; border: none;"></td></tr>');
                    });

                    groupIndex++;
                }
            }

            function exportToExcel() {
                const fromDate = $('#fromDate').val();
                const toDate = $('#toDate').val();

                if (!fromDate || !toDate) {
                    alert('Please select both From and To dates');
                    return;
                }

                const form = $('<form>', {
                    method: 'POST',
                    action: '@Url.Action("ExportToExcel", "StockViewReport")'
                });

                form.append($('<input>', { type: 'hidden', name: 'fromDate', value: fromDate }));
                form.append($('<input>', { type: 'hidden', name: 'toDate', value: toDate }));

                $('body').append(form);
                form.submit();
                form.remove();
            }
        });
    </script>
}
