@model KVM_ERP.Models.TransactionMaster
@{
    ViewBag.Title = "Raw Material Intake - Form";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var supplierList = ViewBag.SupplierList as List<SelectListItem> ?? new List<SelectListItem>();
    var supplierCodeMap = ViewBag.SupplierCodeMap as System.Collections.Generic.Dictionary<string, string> ?? new System.Collections.Generic.Dictionary<string, string>();
}

<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

<style>
    .main-container { background: white; min-height: 100vh; padding: 20px 0; }
    .form-container { background: white; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,.1); margin: 20px; overflow: hidden; border: 1px solid #e9ecef; }
    .form-header { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 25px 30px; border-radius: 15px 15px 0 0; }
    .form-title { font-size: 28px; font-weight: 600; margin: 0; display: flex; align-items: center; gap: 15px; }
    .form-body { padding: 30px; background: white; }
    .form-group { margin-bottom: 18px; }
    .control-label { font-weight: 600; color: #2d3436; margin-bottom: 8px; display: block; }
    .form-control { border: 2px solid #e9ecef; border-radius: 8px; padding: 10px 12px; font-size: 14px; background: #f8f9fa; }
    .form-control:focus { border-color: #4facfe; box-shadow: 0 0 0 0.2rem rgba(79,172,254,.25); background: white; }
    .btn-primary { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); border: none; padding: 12px 30px; border-radius: 25px; font-weight: 600; box-shadow: 0 4px 15px rgba(79,172,254,.4); }
    .btn-secondary { background: linear-gradient(135deg, #6c757d, #495057); border: none; padding: 12px 30px; border-radius: 25px; font-weight: 600; color: #fff; }

    /* Intake Details section styling */
    .intake-details-section { margin-top: 30px; padding: 20px; border: 1px solid #e0e0e0; border-radius: 8px; background-color: #f9f9f9; }
    .details-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
    .details-header .section-title { margin: 0; display: flex; align-items: center; gap: 10px; color: #2c3e50; font-weight: 600; font-size: 16px; }
    .add-btn { background: linear-gradient(135deg, #ff6b6b, #ee5a24); border: none; padding: 10px 18px; border-radius: 25px; color: #fff; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(238, 90, 36, 0.4); display: inline-flex; align-items: center; gap: 8px; text-decoration: none; }
    .add-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(238, 90, 36, 0.6); color: #fff; text-decoration: none; }
    
    /* Production button with same style but different color */
    .production-btn { background: linear-gradient(135deg, #4facfe, #00f2fe); border: none; padding: 10px 18px; border-radius: 25px; color: #fff; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(79, 172, 254, 0.4); display: inline-flex; align-items: center; gap: 8px; text-decoration: none; }
    .production-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(79, 172, 254, 0.6); color: #fff; text-decoration: none; }
    
    /* Enhanced table styling */
    .details-table { background: #fff; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: none; margin-bottom: 0; }
    .details-table thead th { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; font-weight: 600; text-align: center; padding: 15px 10px; border: none; font-size: 14px; }
    .details-table tbody td { padding: 12px 10px; vertical-align: middle; border-color: #e9ecef; }
    .details-table tbody tr:hover { background-color: #f8f9fa; }
    .details-table .form-control { border-radius: 4px; border: 1px solid #ddd; padding: 8px 12px; }
    .details-table .form-control:focus { border-color: #667eea; box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25); }
    .details-table .btn { padding: 6px 12px; border-radius: 4px; font-size: 12px; }
    .add-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(238, 90, 36, 0.6); color: #fff; text-decoration: none; }

    /* Details table aesthetics */
    .details-table { border-radius: 10px; overflow: hidden; background: #fff; }
    .details-table thead th { background: #f1f5f9; color: #334155; font-weight: 700; border-bottom: 2px solid #e2e8f0; }
    .details-table tbody td { vertical-align: middle; }
    .details-table input, .details-table select { height: 36px; padding: 6px 10px; }

    /* Enhanced Tab styling */
    .nav-tabs {
        border-bottom: 3px solid #e3f2fd;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        padding: 8px 15px 0;
        border-radius: 12px 12px 0 0;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    
    .nav-tabs .nav-item {
        margin-bottom: -3px;
        margin-right: 5px;
    }
    
    .nav-tabs .nav-link { 
        color: #6c757d;
        border: none;
        border-radius: 25px 25px 0 0;
        cursor: pointer;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        padding: 12px 20px;
        font-weight: 500;
        font-size: 14px;
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        position: relative;
        overflow: hidden;
        min-width: 120px;
        text-align: center;
    }
    
    .nav-tabs .nav-link::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
        transition: left 0.5s;
    }
    
    .nav-tabs .nav-link:hover::before {
        left: 100%;
    }
    
    .nav-tabs .nav-link:hover { 
        color: #2c3e50;
        background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
        border-color: transparent;
    }
    
    .nav-tabs .nav-link.active { 
        color: #ffffff;
        background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
        font-weight: 600;
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(33, 150, 243, 0.4);
        border-color: transparent;
        z-index: 10;
        position: relative;
    }
    
    .nav-tabs .nav-link.active::after {
        content: '';
        position: absolute;
        bottom: -3px;
        left: 50%;
        transform: translateX(-50%);
        width: 0;
        height: 0;
        border-left: 8px solid transparent;
        border-right: 8px solid transparent;
        border-bottom: 8px solid #ffffff;
    }
    
    .tab-content { 
        border: none;
        background: #ffffff;
        border-radius: 0 0 12px 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    
    .tab-pane { 
        display: none;
        animation: fadeIn 0.3s ease-in-out;
    }
    
    .tab-pane.active { 
        display: block;
    }
    
    @@keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    /* Tab icons */
    .nav-tabs .nav-link i {
        margin-right: 8px;
        font-size: 16px;
    }
    
    /* Responsive tabs */
    @@media (max-width: 768px) {
        .nav-tabs .nav-link {
            padding: 10px 15px;
            font-size: 12px;
            min-width: 100px;
        }
    }
    
    /* Form field transitions for calculation mode switching */
    .form-group {
        transition: all 0.3s ease-in-out;
    }
    
    .form-group.hidden {
        display: none !important;
    }
    
    /* Grade Weight mode styling */
    .grade-weight-mode #slab-calculation-section {
        border: 2px solid #28a745;
        border-radius: 8px;
    }
    
    .grade-weight-mode #total-weight-calculation-section {
        border: 2px solid #ffc107;
        border-radius: 8px;
    }
    
    .grade-weight-mode .card-header {
        font-weight: 600;
    }
    
    /* Calculation Mode Radio Buttons */
    .calculation-mode-section .form-check {
        padding: 15px;
        border: 2px solid #e9ecef;
        border-radius: 10px;
        transition: all 0.3s ease;
        cursor: pointer;
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    }
    
    .calculation-mode-section .form-check:hover {
        border-color: #17a2b8;
        background: linear-gradient(135deg, #e3f7fa 0%, #f0f9ff 100%);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(23, 162, 184, 0.2);
    }
    
    .calculation-mode-section .form-check-input:checked + .form-check-label {
        color: #17a2b8;
        font-weight: 600;
    }
    
    .calculation-mode-section .form-check-input:checked ~ * {
        border-color: #17a2b8;
    }
    
    .calculation-mode-section .form-check.selected {
        border-color: #17a2b8;
        background: linear-gradient(135deg, #e3f7fa 0%, #f0f9ff 100%);
        box-shadow: 0 4px 12px rgba(23, 162, 184, 0.3);
    }
    
    .calculation-mode-section .form-check-label {
        cursor: pointer;
        width: 100%;
    }
    
    .calculation-mode-section .form-check-label i {
        margin-right: 8px;
        font-size: 18px;
    }
    
    /* Enhanced Modal Close Button */
    #productCalculationModal .modal-header .close:hover {
        background: rgba(255,255,255,0.3) !important;
        border-color: rgba(255,255,255,0.5) !important;
        transform: scale(1.1);
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    
    #productCalculationModal .modal-header .close:focus {
        outline: none;
        background: rgba(255,255,255,0.3) !important;
        border-color: rgba(255,255,255,0.5) !important;
        box-shadow: 0 0 0 3px rgba(255,255,255,0.3);
    }
    
    /* Enhanced Production Modal Close Button */
    #productionModal .modal-header .close:hover {
        background: rgba(255,255,255,0.3) !important;
        border-color: rgba(255,255,255,0.5) !important;
        transform: scale(1.1);
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    
    #productionModal .modal-header .close:focus {
        outline: none;
        background: rgba(255,255,255,0.3) !important;
        border-color: rgba(255,255,255,0.5) !important;
        box-shadow: 0 0 0 3px rgba(255,255,255,0.3);
    }
    
    /* Print button styling */
    .print-btn {
        background: linear-gradient(135deg, #28a745, #20c997);
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        color: #fff;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
        display: inline-flex;
        align-items: center;
        gap: 4px;
        text-decoration: none;
        font-size: 12px;
    }
    .print-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.5);
        color: #fff;
        text-decoration: none;
    }
    
    /* Select2 Custom Styling */
    .select2-container {
        width: 100% !important;
    }

    .select2-container--default .select2-selection--single {
        height: 42px;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        background: #f8f9fa;
        display: flex;
        align-items: center;
        padding: 0 12px;
        transition: all 0.3s ease;
    }

    .select2-container--default .select2-selection--single:hover {
        border-color: #4facfe;
    }

    .select2-container--default.select2-container--focus .select2-selection--single,
    .select2-container--default.select2-container--open .select2-selection--single {
        border-color: #4facfe;
        outline: 0;
        background: white;
        box-shadow: 0 0 0 0.2rem rgba(79, 172, 254, 0.25);
    }

    .select2-container--default .select2-selection--single .select2-selection__rendered {
        color: #495057;
        font-size: 14px;
        padding-left: 0;
        line-height: 38px;
    }

    .select2-container--default .select2-selection--single .select2-selection__placeholder {
        color: #6c757d;
        font-size: 14px;
    }

    .select2-container--default .select2-selection--single .select2-selection__arrow {
        height: 38px;
        right: 10px;
    }

    .select2-container--default .select2-selection--single .select2-selection__arrow b {
        border-color: #495057 transparent transparent transparent;
        border-width: 6px 5px 0 5px;
    }

    .select2-container--default.select2-container--open .select2-selection--single .select2-selection__arrow b {
        border-color: transparent transparent #495057 transparent;
        border-width: 0 5px 6px 5px;
    }

    /* Select2 Dropdown Styling */
    .select2-dropdown {
        border: 1px solid #e9ecef;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        margin-top: 4px;
        background: white;
    }

    .select2-container--default .select2-search--dropdown {
        padding: 8px;
        background: white;
    }

    .select2-container--default .select2-search--dropdown .select2-search__field {
        border: 2px solid #e9ecef;
        border-radius: 6px;
        padding: 8px 12px;
        font-size: 14px;
    }

    .select2-container--default .select2-search--dropdown .select2-search__field:focus {
        border-color: #4facfe;
        outline: 0;
        box-shadow: 0 0 0 0.2rem rgba(79, 172, 254, 0.25);
    }

    /* Select2 Results Styling */
    .select2-container--default .select2-results__option {
        padding: 10px 12px;
        font-size: 14px;
    }

    .select2-container--default .select2-results__option--highlighted[aria-selected] {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
    }

    .select2-container--default .select2-results__option[aria-selected=true] {
        background-color: #e7f3ff;
        color: #495057;
    }

    /* Select2 Clear Button Styling */
    .select2-container--default .select2-selection--single .select2-selection__clear {
        color: #6c757d;
        font-size: 18px;
        margin-right: 5px;
        cursor: pointer;
    }

    .select2-container--default .select2-selection--single .select2-selection__clear:hover {
        color: #dc3545;
    }
    
</style>

<div class="main-container">
    <div class="form-container">
        <div class="form-header">
            <h1 class="form-title">
                <i class="fa fa-truck-loading"></i>
                Raw Material Intake
            </h1>
        </div>
        <div class="form-body">
            @Html.Raw(ViewBag.msg)
            @using (Html.BeginForm("savedata", "RawMaterialIntake", FormMethod.Post, new { @class = "form-horizontal", role = "form", id = "rawIntakeForm" }))
            {
                @Html.AntiForgeryToken()
                @Html.HiddenFor(m => m.TRANMID)

                <!-- Single Row: All main fields -->
                <div class="row">
                    <div class="col-md-2">
                        <div class="form-group">
                            <label class="control-label" style="font-weight: 500;">Date <span class="req" style="color: #e74c3c;">*</span></label>
                            @Html.TextBoxFor(m => m.TRANDATE, "{0:yyyy-MM-dd}", new { @class = "form-control", type = "date", required = "required", style = "border-radius: 4px;" })
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label class="control-label" style="font-weight: 500;">Supplier Name <span class="req" style="color: #e74c3c;">*</span></label>
                            @Html.DropDownList("SupplierId", supplierList, "-- Select Supplier --", new { @class = "form-control select2", id = "supplierDropdown", required = "required", style = "width:100%; border-radius: 4px;" })
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group">
                            <label class="control-label" style="font-weight: 500;">Supplier Code</label>
                            @Html.TextBoxFor(m => m.CATECODE, new { @class = "form-control", @id = "supplierCode", @readonly = "readonly", style = "border-radius: 4px;" })
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group">
                            <label class="control-label" style="font-weight: 500;">Vehicle No <span class="req" style="color: #e74c3c;">*</span></label>
                            @Html.TextBoxFor(m => m.VECHNO, new { @class = "form-control", placeholder = "Enter vehicle number", required = "required", maxlength = 50, style = "border-radius: 4px;" })
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group">
                            <label class="control-label" style="font-weight: 500;">Client Weight <span class="req" style="color: #e74c3c;">*</span></label>
                            @Html.TextBoxFor(m => m.CLIENTWGHT, new { @class = "form-control", placeholder = "Enter weight", required = "required", type = "number", step = "0.001", min = "0", style = "border-radius: 4px;" })
                        </div>
                    </div>
                    <div class="col-md-1">
                        <div class="form-group">
                            <label class="control-label" style="font-weight: 500;">Status</label>
                            @Html.DropDownListFor(m => m.DISPSTATUS,
                                new SelectList(new[] {
                                    new SelectListItem { Text = "Enabled", Value = "0" },
                                    new SelectListItem { Text = "Disabled", Value = "1" }
                                }, "Value", "Text", Model.DISPSTATUS.ToString()),
                                new { @class = "form-control", id = "statusDropdown", style = "border-radius: 4px;" })
                        </div>
                    </div>
                </div>

                <!-- Quality Check Section -->
                <div class="quality-check-section" style="margin-top: 30px; padding: 20px; border: 1px solid #e0e0e0; border-radius: 8px; background-color: #f9f9f9;">
                    <div class="section-title" style="margin-bottom: 20px; color: #2c3e50; font-weight: 600;">
                        <i class="fa fa-check-circle" style="color: #27ae60;"></i> Quality Check
                    </div>
                    
                    <!-- First Row: Lab Testing, Status, Done By, Verified By, Date -->
                    <div class="row">
                        <div class="col-md-2">
                            <div class="form-group">
                                <label class="control-label" style="font-weight: 500;">Lab Testing <span class="req" style="color: #e74c3c;">*</span></label>
                                <select class="form-control" id="laboratoryDropdown" required style="border-radius: 4px;">
                                    <option value="">-- Select Laboratory --</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-group">
                                <label class="control-label" style="font-weight: 500;">Status <span class="req" style="color: #e74c3c;">*</span></label>
                                <select class="form-control" id="qualityStatusDropdown" required style="border-radius: 4px;">
                                    <option value="">-- Select Status --</option>
                                    <option value="0">Verified</option>
                                    <option value="1">Not Verified</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-group">
                                <label class="control-label" style="font-weight: 500;">Done By <span class="req" style="color: #e74c3c;">*</span></label>
                                <input type="text" class="form-control" id="doneBy" placeholder="Enter name" required maxlength="100" style="border-radius: 4px;" />
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="control-label" style="font-weight: 500;">Verified By <span class="req" style="color: #e74c3c;">*</span></label>
                                <input type="text" class="form-control" id="verifiedBy" placeholder="Enter name" required maxlength="100" style="border-radius: 4px;" />
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="control-label" style="font-weight: 500;">Date <span class="req" style="color: #e74c3c;">*</span></label>
                                <input type="date" class="form-control" id="lotDate" required style="border-radius: 4px;" />
                            </div>
                        </div>
                    </div>

                    <!-- Second Row: Remarks (Full Width) -->
                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label class="control-label" style="font-weight: 500;">Remarks <span class="req" style="color: #e74c3c;">*</span></label>
                                <textarea class="form-control" id="remarks" placeholder="Enter quality check remarks..." required rows="3" style="border-radius: 4px; resize: vertical;"></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-group text-center form-actions" style="margin-top: 30px;">
                    <a href="@Url.Action("Index", "RawMaterialIntake")" class="btn btn-secondary">
                        <i class="fa fa-arrow-left"></i> Back to List
                    </a>
                    <button type="submit" class="btn btn-primary" id="saveBtn">
                        <i class="fa fa-save"></i> Save
                    </button>
                </div>
                
                @* Details JSON holder *@
                <input type="hidden" id="detailRowsJson" name="detailRowsJson" />
                @* Quality Check JSON holder *@
                <input type="hidden" id="qualityCheckJson" name="qualityCheckJson" />
            }
        </div>
    </div>
</div>

@section Scripts {
    <!-- Select2 JS from CDN -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    
    <script>
        console.log('=== RAW MATERIAL INTAKE FORM SCRIPT STARTING ===');
        (function(){
            console.log('IIFE started - JavaScript is running');
            
            // Initialize Select2 on Supplier dropdown with search functionality
            $('#supplierDropdown').select2({
                placeholder: '-- Select Supplier --',
                allowClear: true,
                width: '100%'
            });
            console.log('Select2 initialized on supplier dropdown');
            var codeMap = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(supplierCodeMap));
            var $supplier = $('#supplierDropdown');
            var $code = $('#supplierCode');
            var details = @Html.Raw(ViewBag.DetailsJson ?? "[]");
            var materialGroups = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(ViewBag.MaterialGroups ?? new List<SelectListItem>()));
            var existingQualityCheck = @Html.Raw(ViewBag.QualityCheckJson ?? "null");
            
            console.log('Variables initialized');
            console.log('Details from server:', details);
            console.log('Material groups count:', materialGroups ? materialGroups.length : 0);

            function syncCode(){
                var val = $supplier.val();
                if (val && codeMap[val] !== undefined) {
                    $code.val(codeMap[val] || '');
                } else {
                    $code.val('');
                }
            }

            $supplier.on('change', syncCode);
            // Enable search on supplier dropdown if select2 is available
            if ($.fn.select2) {
                $('#supplierDropdown').select2({ placeholder: '-- Select Supplier --', allowClear: true, width: 'resolve' });
            }
            // Initialize on load
            syncCode();

            // Force status dropdown to reflect model value
            var modelStatus = '@Model.DISPSTATUS';
            $('#statusDropdown').val(modelStatus).trigger('change');

            // -------- Quality Check Functionality --------
            // Load laboratories dropdown
            function loadLaboratories() {
                $.getJSON('@Url.Action("GetLaboratories", "RawMaterialIntake")')
                    .done(function(data) {
                        var $lab = $('#laboratoryDropdown');
                        $lab.empty().append('<option value="">-- Select Laboratory --</option>');
                        $.each(data, function(_, item) {
                            $lab.append('<option value="' + item.id + '">' + item.text + '</option>');
                        });
                        
                        // Load existing quality check data AFTER laboratories are loaded
                        loadQualityCheck();
                    })
                    .fail(function() {
                        console.error('Failed to load laboratories');
                    });
            }

            // Load existing quality check data
            function loadQualityCheck() {
                if (existingQualityCheck) {
                    $('#laboratoryDropdown').val(existingQualityCheck.LABOID);
                    $('#qualityStatusDropdown').val(existingQualityCheck.STATUS);
                    $('#doneBy').val(existingQualityCheck.DONEBY);
                    $('#verifiedBy').val(existingQualityCheck.VERIFIEDBY);
                    $('#lotDate').val(existingQualityCheck.LOTDATE ? existingQualityCheck.LOTDATE.substring(0, 10) : '');
                    $('#remarks').val(existingQualityCheck.REMARKS);
                }
            }


            // Check if quality check table exists and initialize
            function initializeQualityCheck() {
                $.getJSON('@Url.Action("CheckQualityCheckTable", "RawMaterialIntake")')
                    .done(function(response) {
                        if (response.tableExists) {
                            loadLaboratories(); // This will call loadQualityCheck() after laboratories are loaded
                        } else {
                            console.error('Quality Check table does not exist:', response.message);
                            // Disable quality check fields
                            $('#laboratoryDropdown, #qualityStatusDropdown, #doneBy, #verifiedBy, #lotDate, #remarks').prop('disabled', true);
                            // Show warning message
                            $('.section-title:contains("Quality Check")').after('<div class="alert alert-warning mt-2"><strong>Warning:</strong> ' + response.message + '</div>');
                        }
                    })
                    .fail(function() {
                        console.error('Failed to check quality check table status');
                    });
            }

            // Initialize quality check
            initializeQualityCheck();

            // Form submit to serialize both details and quality check
            $('#rawIntakeForm').on('submit', function(e) {
                e.preventDefault(); // Prevent default form submission
                
                // Serialize details data
                var rows = [];
                $tbody.children('tr').each(function(){
                    var gid = parseInt($(this).find('select.mgroup').val()||'0',10);
                    var pid = parseInt($(this).find('select.product').val()||'0',10);
                    var nbox = parseInt($(this).find('input.nbox').val()||'0',10);
                    var cnt = parseInt($(this).find('input.counts').val()||'0',10);
                    var trandid = parseInt($(this).data('trandid')||'0',10);
                    if (gid>0 && pid>0 && nbox>=0 && cnt>=0){
                        rows.push({ TRANDID: trandid, MTRLGID: gid, MTRLID: pid, MTRLNBOX: nbox, MTRLCOUNTS: cnt });
                    }
                });

                // Serialize quality check data
                var qualityData = null;
                var laboid = parseInt($('#laboratoryDropdown').val()) || 0;
                var status = parseInt($('#qualityStatusDropdown').val()) || 0;
                var doneby = $('#doneBy').val().trim();
                var verifiedby = $('#verifiedBy').val().trim();
                var lotdate = $('#lotDate').val();
                var remarks = $('#remarks').val().trim();

                // Only include quality check if essential fields are filled (remarks is optional)
                if (laboid > 0 && doneby && verifiedby && lotdate) {
                    qualityData = {
                        LABOID: laboid,
                        STATUS: status,
                        DONEBY: doneby,
                        VERIFIEDBY: verifiedby,
                        LOTDATE: lotdate,
                        REMARKS: remarks || ''
                    };
                }
                
                // IMPORTANT: Populate the hidden fields with JSON data
                var detailsJson = JSON.stringify(rows);
                var qualityJson = qualityData ? JSON.stringify(qualityData) : '';
                
                $('#detailRowsJson').val(detailsJson);
                $('#qualityCheckJson').val(qualityJson);
                
                // Submit via AJAX to handle JSON response
                $.ajax({
                    url: '@Url.Action("savedata", "RawMaterialIntake")',
                    type: 'POST',
                    data: $(this).serialize(),  // Now the hidden fields have the data!
                    success: function(response) {
                        // Server returns redirect, so we redirect to Index
                        window.location.href = '@Url.Action("Index", "RawMaterialIntake")';
                    },
                    error: function(xhr, status, error) {
                        console.error('AJAX Error:', status, error);
                        console.error('Response:', xhr.responseText);
                        alert('Error saving data: ' + error + '\nStatus: ' + xhr.status + '\nCheck console for details');
                    }
                });
            });

            // -------- Details Table UI --------
            var $intakeDetailsSection = $('<div class="intake-details-section"></div>');
            var $detailsHeader = $('<div class="details-header"></div>');
            var $detailsSection = $('<div class="section-title"><i class="fa fa-list" style="color: #667eea;"></i> Intake Details</div>');
            var $toolbar = $('<div class="mb-2"></div>');
            var $addBtn = $('<button type="button" class="add-btn" id="addRowBtn"><i class="fa fa-plus"></i> Add</button>');
            
            // Add Production button only in edit mode
            @if (Model.TRANMID > 0)
            {
                <text>
            var $productionBtn = $('<button type="button" class="production-btn ml-2" id="productionBtn"><i class="fa fa-industry"></i> Production</button>');
            console.log('Creating Production button for edit mode, TRANMID:', @Model.TRANMID);
            $toolbar.append($addBtn, $productionBtn);
            console.log('Production button appended to toolbar');
                </text>
            }
            else
            {
                <text>
            console.log('Not creating Production button - not in edit mode, TRANMID:', @Model.TRANMID);
            $toolbar.append($addBtn);
                </text>
            }
            $detailsHeader.append($detailsSection).append($toolbar);

            var $table = $('<table class="table table-bordered details-table" id="detailsTable"></table>');
            var $thead = $('<thead><tr>\
                <th style="width:60px;">S.No</th>\
                <th style="width:200px;">Product Type</th>\
                <th style="width:250px;">Product</th>\
                <th style="width:120px;">No. of Boxes</th>\
                <th style="width:120px;">Count (Per KG)</th>\
                <th style="width:130px;">Weight(In KGS)</th>\
                <th style="width:80px;">Action</th>\
            </tr></thead>');
            var $tbody = $('<tbody></tbody>');
            var $tfoot = $('<tfoot><tr class="total-weights-row" style="background: linear-gradient(135deg, #28a745, #20c997); color: white; font-weight: bold;">\
                <td colspan="5" class="text-center" style="padding: 12px;">Total Weights</td>\
                <td class="text-center" style="padding: 12px;"><span id="totalWeightDisplay">0.000 KG</span></td>\
                <td></td>\
            </tr></tfoot>');
            $table.append($thead).append($tbody).append($tfoot);

            // Wrap everything in the styled section
            $intakeDetailsSection.append($detailsHeader).append($table);

            // Insert after the main form row
            console.log('=== INSERTING INTAKE DETAILS TABLE ===');
            console.log('Looking for selector:', '.form-body .row');
            var $targetRow = $('.form-body .row').last();
            console.log('Found target row:', $targetRow.length, 'elements');
            if ($targetRow.length > 0) {
                $targetRow.after($intakeDetailsSection);
                console.log('✓ Intake Details table inserted successfully');
                console.log('Table ID:', $('#detailsTable').length > 0 ? 'Found' : 'NOT FOUND');
            } else {
                console.error('✗ ERROR: Could not find .form-body .row element!');
                console.log('Trying alternative: inserting at end of form-body');
                $('.form-body').append($intakeDetailsSection);
            }

            function buildGroupSelect(selectedId){
                var $sel = $('<select class="form-control mgroup"></select>');
                $sel.append('<option value="">-- Select Group --</option>');
                $.each(materialGroups || [], function(_, g){
                    var opt = $('<option></option>').val(g.Value).text(g.Text);
                    if (selectedId && selectedId.toString() === g.Value) opt.prop('selected', true);
                    $sel.append(opt);
                });
                return $sel;
            }

            function buildProductSelect(){
                var $sel = $('<select class="form-control product"><option value="">-- Select Product --</option></select>');
                return $sel;
            }

            function loadProducts($row, groupId, selectedProductId){
                var $prod = $row.find('select.product');
                
                // Destroy existing Select2 instance before modifying options
                if ($prod.hasClass('select2-hidden-accessible')) {
                    $prod.select2('destroy');
                }
                
                $prod.empty().append('<option value="">Loading...</option>');
                if (!groupId) { 
                    $prod.html('<option value="">-- Select Product --</option>');
                    // Reinitialize Select2
                    $prod.select2({
                        placeholder: '-- Select Product --',
                        allowClear: true,
                        width: '100%',
                        dropdownParent: $prod.parent()
                    });
                    return; 
                }
                $.getJSON('@Url.Action("GetProducts","RawMaterialIntake")', { groupId: groupId })
                 .done(function(list){
                    $prod.empty().append('<option value="">-- Select Product --</option>');
                    $.each(list, function(_, item){
                        var opt = $('<option></option>').val(item.id).text(item.text);
                        if (selectedProductId && selectedProductId.toString() === item.id.toString()) opt.prop('selected', true);
                        $prod.append(opt);
                    });
                    // Reinitialize Select2 after loading products
                    $prod.select2({
                        placeholder: '-- Select Product --',
                        allowClear: true,
                        width: '100%',
                        dropdownParent: $prod.parent()
                    });
                    // Set selected value if provided
                    if (selectedProductId) {
                        $prod.val(selectedProductId).trigger('change.select2');
                    }
                 })
                 .fail(function(){ 
                    $prod.html('<option value="">-- Select Product --</option>');
                    // Reinitialize Select2 even on failure
                    $prod.select2({
                        placeholder: '-- Select Product --',
                        allowClear: true,
                        width: '100%',
                        dropdownParent: $prod.parent()
                    });
                 });
            }

            function addRow(init){
                var idx = $tbody.children('tr').length + 1;
                var $tr = $('<tr></tr>');
                var $sno = $('<td class="text-center align-middle"></td>').text(idx);
                var $gtd = $('<td></td>');
                var $ptd = $('<td></td>');
                var $box = $('<td></td>').append('<input type="number" min="0" class="form-control nbox" placeholder="0" />');
                var $cnt = $('<td></td>').append('<input type="number" min="0" class="form-control counts" placeholder="0" />');
                var $weight = $('<td class="text-center align-middle"></td>').append('<span class="factory-weight-display text-muted">-</span>');
                var $act = $('<td class="text-center"></td>');
                var $del = $('<button type="button" class="btn btn-danger btn-sm removeRow"><i class="fa fa-trash"></i></button>');
                
                // Add P button and Print button only in edit mode
                @if (Model.TRANMID > 0)
                {
                    <text>
                var $pBtn = $('<button type="button" class="btn btn-primary btn-sm ml-1 productCalcBtn" title="Product Calculation"><i class="fa fa-calculator"></i> P</button>');
                var $printBtn = $('<button type="button" class="btn btn-success btn-sm ml-1 printCalcBtn" title="Print Calculation"><i class="fa fa-print"></i></button>');
                $act.append($del, $pBtn, $printBtn);
                    </text>
                }
                else
                {
                    <text>
                $act.append($del);
                    </text>
                }

                var $gsel = buildGroupSelect(init && init.MTRLGID);
                var $psel = buildProductSelect();
                $gtd.append($gsel);
                $ptd.append($psel);

                $tr.append($sno, $gtd, $ptd, $box, $cnt, $weight, $act);
                $tbody.append($tr);

                // Initialize Select2 on newly added dropdowns
                $gsel.select2({
                    placeholder: '-- Select Group --',
                    allowClear: true,
                    width: '100%',
                    dropdownParent: $gtd
                });
                
                $psel.select2({
                    placeholder: '-- Select Product --',
                    allowClear: true,
                    width: '100%',
                    dropdownParent: $ptd
                });

                // carry TRANDID for existing rows (0 for new)
                $tr.data('trandid', (init && init.TRANDID) ? init.TRANDID : 0);

                if (init) {
                    loadProducts($tr, init.MTRLGID, init.MTRLID);
                    if (init.MTRLNBOX) $tr.find('input.nbox').val(init.MTRLNBOX);
                    if (init.MTRLCOUNTS) $tr.find('input.counts').val(init.MTRLCOUNTS);
                }

                // Wire events
                $gsel.on('change', function(){
                    var gid = $(this).val();
                    loadProducts($tr, gid, null);
                });
                return $tr;
            }

            function renumber(){
                $tbody.children('tr').each(function(i){
                    $(this).children('td').first().text(i+1);
                });
            }

            $('#addRowBtn').on('click', function(){ addRow(); });
            $tbody.on('click', '.removeRow', function(){
                $(this).closest('tr').remove();
                renumber();
                // Update total weights after row removal
                updateTotalWeights();
            });

            // Load existing rows
            if (Array.isArray(details)) {
                details.forEach(function(d){ addRow(d); });
                
                // Load factory weights for existing rows after a short delay
                setTimeout(function() {
                    loadAllFactoryWeights();
                }, 1000);
            }
            


            // Product Calculation Button Click Handler
            $tbody.on('click', '.productCalcBtn', function(){
                console.log('=== P BUTTON CLICKED ===');
                var $row = $(this).closest('tr');
                var trandid = parseInt($row.data('trandid')||'0',10);
                
                console.log('Row TRANDID:', trandid);
                
                if (trandid <= 0) {
                    alert('Please save the products first before calculating.');
                    return;
                }
                
                // Get row data for display
                var supplierName = '@Model.CATENAME';
                var supplierCode = '@Model.CATECODE';
                var productType = $row.find('select.mgroup option:selected').text();
                var product = $row.find('select.product option:selected').text();
                var noOfBoxes = $row.find('input.nbox').val();
                var countPerKg = $row.find('input.counts').val();
                
                console.log('Opening Product Calculation Modal for TRANDID:', trandid);
                console.log('Product Type:', productType, 'Product:', product);
                openProductCalculationModal(trandid, supplierName, supplierCode, productType, product, noOfBoxes, countPerKg);
            });
            
            // Print Calculation Button Click Handler - SIMPLIFIED: Direct PDF generation
            $tbody.on('click', '.printCalcBtn', function(){
                console.log('Print button clicked');
                var $row = $(this).closest('tr');
                var trandid = parseInt($row.data('trandid')||'0',10);
                
                console.log('TRANDID from row:', trandid);
                
                if (trandid <= 0) {
                    alert('Please save the products first before printing.');
                    return;
                }
                
                console.log('Generating PDF directly for TRANDID:', trandid);
                // Generate PDF for this specific row only
                generateRowPDF(trandid);
            });

        })();

        // Product Calculation Modal Functions
        // --- Helpers to stabilize global factory fields population ---
        function resolveFactoryFieldsFromTabs() {
            var weight = null, count = null;
            $('.tab-pane').each(function(){
                var stored = $(this).data('existing-calculation');
                if (stored) {
                    if (weight === null && (stored.FACAVGWGT || stored.FACAVGWGT === 0)) {
                        weight = stored.FACAVGWGT;
                    }
                    if (count === null && (stored.FACAVGCOUNT || stored.FACAVGCOUNT === 0)) {
                        count = stored.FACAVGCOUNT;
                    }
                }
            });
            return { weight: weight, count: count };
        }

        function ensureFactoryFieldsPopulated() {
            var $w = $('#facAvgWeight');
            var $c = $('#facAvgCount');
            if (!$w.length || !$c.length) return;

            var vals = resolveFactoryFieldsFromTabs();
            if ((!$w.val() || $w.val() === '') && (vals.weight || vals.weight === 0)) {
                $w.val(vals.weight);
            }
            if ((!$c.val() || $c.val() === '') && (vals.count || vals.count === 0)) {
                $c.val(vals.count);
            }
        }
        function openProductCalculationModal(trandid, supplierName, supplierCode, productType, product, noOfBoxes, countPerKg) {
            // IMPORTANT: Show modal FIRST so DOM elements exist
            // Clear any existing modal state
            $('#productCalculationModal').removeClass('show').hide();
            $('.modal-backdrop').remove();
            $('body').removeClass('modal-open');
            
            // Show modal using direct method
            $('#productCalculationModal').show().addClass('show fade');
            $('body').addClass('modal-open');
            $('<div class="modal-backdrop fade show"></div>').appendTo('body');
            
            console.log('Modal shown - DOM elements are now available');
            
            // Populate display fields
            $('#modal-supplier-name').text(supplierName);
            $('#modal-supplier-code').text(supplierCode);
            $('#modal-product-type').text(productType);
            $('#modal-product').text(product);
            $('#modal-no-boxes').text(noOfBoxes);
            $('#modal-count-per-kg').text(countPerKg);
            $('#modal-client-weight').text('@(Model != null ? (Model.CLIENTWGHT.ToString("0.000")) : "")');
            
            // Store TRANDID for saving
            $('#productCalculationModal').data('trandid', trandid);
            
            // IMPORTANT: Clear cached data AND field containers from previous modal opens
            $('.tab-pane').each(function() {
                $(this).removeData('existing-calculation');
                // Also clear the field containers so fields will be reloaded
                $(this).find('.packing-fields-container').empty();
            });
            console.log('Cleared cached calculation data and field containers for fresh load');
            
            // Clear all tab calculations
            $('.tab-pane .calculation-result').text('0.000');
            $('.tab-pane .total-counts').text('0');
            $('.tab-pane input').val('');
            
            // DON'T clear the production date field - preserve it for edit mode
            // The date field is outside tab panes, so it shouldn't be affected by the above clearing
            console.log('Modal opening - current date field value:', $('#prodDate').val());
            
            // IMMEDIATE date setting - check if we have any existing data for this transaction
            console.log('Checking for existing date data for TRANDID:', trandid);
            
            // Try to get date from server immediately
            var firstPackingId = $('#packingMasterTabs .nav-link').first().data('packing-id');
            console.log('First packing ID for date check:', firstPackingId);
            
            $.ajax({
                url: '@Url.Action("GetProductCalculation", "RawMaterialIntake")',
                type: 'GET',
                data: { trandid: trandid, packingId: firstPackingId },
                success: function(data) {
                    console.log('=== IMMEDIATE DATE CHECK RESPONSE ===');
                    console.log('Success:', data.success);
                    console.log('Has calculation:', !!data.calculation);
                    console.log('Full response:', data);
                    if (data.success && data.calculation && data.calculation.PRODDATE) {
                        try {
                            const prodDate = new Date(data.calculation.PRODDATE);
                            if (!isNaN(prodDate.getTime())) {
                                const formattedDate = prodDate.toISOString().split('T')[0];
                                const dateField = $('#prodDate');
                                
                                console.log('IMMEDIATE DATE SET - Raw:', data.calculation.PRODDATE);
                                console.log('IMMEDIATE DATE SET - Formatted:', formattedDate);
                                
                                if (dateField.length > 0) {
                                    // Try multiple methods to set the date
                                    dateField.val(formattedDate);
                                    dateField[0].value = formattedDate; // Direct DOM property
                                    dateField.attr('value', formattedDate); // Attribute method
                                    
                                    console.log('IMMEDIATE DATE SET - Success:', dateField.val());
                                    console.log('IMMEDIATE DATE SET - DOM value:', dateField[0].value);
                                    
                                    // Force trigger change event to ensure it sticks
                                    dateField.trigger('change');
                                    dateField.trigger('input');
                                }
                            }
                        } catch (error) {
                            console.error('IMMEDIATE DATE SET - Error:', error);
                        }
                    } else {
                        console.log('✗ No date found in calculation data');
                    }
                    
                    // Also set global Client Factory fields if present
                    if (data && data.success && data.calculation) {
                        if ($('#facAvgWeight').length && !$('#facAvgWeight').val() && (data.calculation.FACAVGWGT || data.calculation.FACAVGWGT === 0)) {
                            $('#facAvgWeight').val(data.calculation.FACAVGWGT);
                        }
                        if ($('#facAvgCount').length && !$('#facAvgCount').val() && (data.calculation.FACAVGCOUNT || data.calculation.FACAVGCOUNT === 0)) {
                            $('#facAvgCount').val(data.calculation.FACAVGCOUNT);
                        }
                    }
                },
                error: function(xhr, status, error) {
                    console.log('✗ AJAX error getting date:', status, error);
                }
            });
            
            // OPTIMIZED: Batch load all calculations in ONE request
            console.log('Batch loading all calculations for TRANDID:', trandid);
            
            $.ajax({
                url: '@Url.Action("GetAllProductCalculations", "RawMaterialIntake")',
                type: 'GET',
                data: { trandid: trandid },
                success: function(response) {
                    console.log('Batch loaded calculations:', response);
                    
                    if (response.success && response.calculations && response.calculations.length > 0) {
                        // Store all calculations in their respective tab panes
                        response.calculations.forEach(function(calc) {
                            const packingId = calc.PACKMID;
                            const paneSelector = `#pane-${packingId}`;
                            const $pane = $(paneSelector);
                            $pane.data('existing-calculation', calc);
                            console.log('Stored calculation for packing ID:', packingId);

                            // Store per-tab Grade / Colour / Received Type so each tab can have its own values
                            if (calc.GRADEID) {
                                $pane.data('grade-id', calc.GRADEID);
                            }
                            if (calc.PCLRID) {
                                $pane.data('colour-id', calc.PCLRID);
                            }
                            if (calc.RCVDTID) {
                                $pane.data('received-type-id', calc.RCVDTID);
                            }
                            
                            // Set global factory fields from first calculation
                            if (!$('#facAvgWeight').val() && (calc.FACAVGWGT || calc.FACAVGWGT === 0)) {
                                $('#facAvgWeight').val(calc.FACAVGWGT);
                            }
                            if (!$('#facAvgCount').val() && (calc.FACAVGCOUNT || calc.FACAVGCOUNT === 0)) {
                                $('#facAvgCount').val(calc.FACAVGCOUNT);
                            }
                            
                            // Set production date from first calculation with a date
                            if (calc.PRODDATE && !$('#prodDate').val()) {
                                try {
                                    const prodDate = new Date(calc.PRODDATE);
                                    if (!isNaN(prodDate.getTime())) {
                                        const formattedDate = prodDate.toISOString().split('T')[0];
                                        $('#prodDate').val(formattedDate);
                                        console.log('Set date from calculation:', formattedDate);
                                    }
                                } catch (error) {
                                    console.error('Error setting date:', error);
                                }
                            }
                        });
                        
                        // IMPORTANT: Set global fields from first calculation
                        // Use small delay to ensure modal DOM is fully rendered
                        setTimeout(function() {
                            if (response.calculations.length > 0) {
                                const firstCalc = response.calculations[0];
                                
                                // Set production date with verification
                                if (firstCalc.PRODDATE) {
                                    console.log('=== DATE SETTING DEBUG ===');
                                    console.log('Raw PRODDATE:', firstCalc.PRODDATE);
                                    console.log('#prodDate exists:', $('#prodDate').length > 0);
                                    console.log('#prodDate visible:', $('#prodDate').is(':visible'));
                                    
                                    try {
                                    let formattedDate;
                                    
                                    // Handle .NET JSON date format: /Date(1762194600000)/
                                    if (typeof firstCalc.PRODDATE === 'string' && firstCalc.PRODDATE.indexOf('/Date(') === 0) {
                                        const timestamp = parseInt(firstCalc.PRODDATE.match(/\d+/)[0]);
                                        const prodDate = new Date(timestamp);
                                        if (!isNaN(prodDate.getTime())) {
                                            formattedDate = prodDate.toISOString().split('T')[0];
                                            console.log('.NET date parsed - timestamp:', timestamp, 'formatted:', formattedDate);
                                        }
                                    }
                                    // Handle standard YYYY-MM-DD format
                                    else if (typeof firstCalc.PRODDATE === 'string' && firstCalc.PRODDATE.match(/^\d{4}-\d{2}-\d{2}$/)) {
                                        formattedDate = firstCalc.PRODDATE;
                                        console.log('Standard date format used:', formattedDate);
                                    }
                                    // Handle other date formats
                                    else {
                                        const prodDate = new Date(firstCalc.PRODDATE);
                                        if (!isNaN(prodDate.getTime())) {
                                            formattedDate = prodDate.toISOString().split('T')[0];
                                            console.log('Generic date parsed:', formattedDate);
                                        }
                                    }
                                    
                                    console.log('Formatted date:', formattedDate);
                                        
                                        if (formattedDate) {
                                            const dateField = $('#prodDate');
                                            if (dateField.length > 0) {
                                                // Clear first
                                                dateField.val('');
                                                // Set value
                                                dateField.val(formattedDate);
                                                // Force update
                                                dateField[0].value = formattedDate;
                                                dateField.trigger('change');
                                                
                                                console.log('✓ Date field set to:', formattedDate);
                                                console.log('Verification - jQuery val():', dateField.val());
                                                console.log('Verification - DOM value:', dateField[0].value);
                                            } else {
                                                console.error('✗ Date field #prodDate NOT FOUND in DOM!');
                                            }
                                        } else {
                                            console.error('✗ Could not format date');
                                        }
                                    } catch (error) {
                                        console.error('✗ Error setting date:', error);
                                    }
                                } else {
                                    console.log('No PRODDATE in first calculation');
                                }
                                
                                // Set factory fields
                                if (firstCalc.FACAVGWGT !== null && firstCalc.FACAVGWGT !== undefined) {
                                    $('#facAvgWeight').val(firstCalc.FACAVGWGT);
                                    console.log('✓ Factory Avg Weight set:', firstCalc.FACAVGWGT);
                                }
                                if (firstCalc.FACAVGCOUNT !== null && firstCalc.FACAVGCOUNT !== undefined) {
                                    $('#facAvgCount').val(firstCalc.FACAVGCOUNT);
                                    console.log('✓ Factory Avg Count set:', firstCalc.FACAVGCOUNT);
                                }
                                
                                // Set dropdowns for the FIRST tab only (per-tab values are synced on tab switch)
                                if (firstCalc.GRADEID) {
                                    $('#gradeId').val(firstCalc.GRADEID);
                                    console.log('✓ Grade set (initial):', firstCalc.GRADEID);
                                }
                                if (firstCalc.PCLRID) {
                                    $('#colourId').val(firstCalc.PCLRID);
                                    console.log('✓ Colour set (initial):', firstCalc.PCLRID);
                                }
                                if (firstCalc.RCVDTID) {
                                    $('#receivedTypeId').val(firstCalc.RCVDTID);
                                    console.log('✓ Received Type set (initial):', firstCalc.RCVDTID);
                                }
                            }
                        }, 100); // Small delay to ensure modal DOM is ready
                        
                        // Find which tab to activate (first one with data)
                        let tabToActivate = null;
                        let packingIdToActivate = null;
                        
                        $('#packingMasterTabs .nav-link').each(function() {
                            const packingId = $(this).data('packing-id');
                            const tabPane = $(`#pane-${packingId}`);
                            const storedCalculation = tabPane.data('existing-calculation');
                            
                            if (storedCalculation && Object.keys(storedCalculation).length > 0) {
                                tabToActivate = $(this);
                                packingIdToActivate = packingId;
                                console.log('EDIT MODE: Found saved data for packing ID:', packingId);
                                return false; // Break - use first tab with data
                            }
                        });
                        
                        // If no saved data, use first tab (ADD mode)
                        if (!tabToActivate) {
                            tabToActivate = $('#packingMasterTabs .nav-link').first();
                            packingIdToActivate = tabToActivate.data('packing-id');
                            console.log('ADD MODE: Activating first tab (Head On):', packingIdToActivate);
                        }
                        
                        // Activate selected tab and load its fields
                        if (tabToActivate && tabToActivate.length > 0) {
                            $('#packingMasterTabs .nav-link').removeClass('active');
                            $('.tab-pane').removeClass('show active');
                            tabToActivate.addClass('active');
                            $(`#pane-${packingIdToActivate}`).addClass('show active');
                            
                            // Load fields for active tab
                            loadPackingTypeFieldsForTab(packingIdToActivate);
                            
                            // IMPORTANT: Populate data after fields are loaded
                            const activeTabPane = $(`#pane-${packingIdToActivate}`);
                            const activeCalc = activeTabPane.data('existing-calculation');
                            if (activeCalc && Object.keys(activeCalc).length > 0) {
                                console.log('Populating active tab data after batch load:', packingIdToActivate);
                                setTimeout(function() {
                                    populateTabCalculation(activeCalc, packingIdToActivate);
                                }, 400); // Wait for fields to load
                            }
                            
                            // Update radio buttons after fields load
                            setTimeout(function() {
                                updateRadioButtonsForActiveTab();
                            }, 300);
                        }
                    } else {
                        // No calculations found - ADD mode
                        console.log('No existing calculations - ADD mode');
                        const firstTab = $('#packingMasterTabs .nav-link').first();
                        const packingId = firstTab.data('packing-id');
                        
                        $('#packingMasterTabs .nav-link').removeClass('active');
                        $('.tab-pane').removeClass('show active');
                        firstTab.addClass('active');
                        $(`#pane-${packingId}`).addClass('show active');
                        
                        loadPackingTypeFieldsForTab(packingId);
                        
                        setTimeout(function() {
                            updateRadioButtonsForActiveTab();
                        }, 300);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error batch loading calculations:', error);
                    // Fallback to first tab on error
                    const firstTab = $('#packingMasterTabs .nav-link').first();
                    const packingId = firstTab.data('packing-id');
                    
                    $('#packingMasterTabs .nav-link').removeClass('active');
                    $('.tab-pane').removeClass('show active');
                    firstTab.addClass('active');
                    $(`#pane-${packingId}`).addClass('show active');
                    
                    loadPackingTypeFieldsForTab(packingId);
                }
            });
            
            // Set default calculation mode and trigger form layout
            setTimeout(function() {
                // Ensure default packing mode is selected and form is properly displayed
                if (!$('input[name="calculationMode"]:checked').length) {
                    $('input[name="calculationMode"][value="packing"]').prop('checked', true).trigger('change');
                    console.log('Set default calculation mode for new calculation');
                }
                
                // Force recalculation for all tabs after modal is fully loaded
                setTimeout(function() {
                    $('.tab-pane').each(function() {
                        const tabPane = $(this);
                        const hasData = tabPane.find('.pck-field').filter(function() {
                            return $(this).val() && parseFloat($(this).val()) > 0;
                        }).length > 0;
                        
                        if (hasData) {
                            console.log('Force calculating for tab:', tabPane.attr('id'));
                            calculateTabTotals(tabPane);
                        }
                    });
                }, 400); // Reduced from 2000ms to 400ms since data is batch-loaded
            }, 100);
        }


        // Manual tab switching function
        function switchTab(packingId) {
            console.log('Switching to tab:', packingId);
            
            // Remove active class from all tabs and panes
            $('#packingMasterTabs .nav-link').removeClass('active');
            $('.tab-pane').removeClass('show active');
            
            // Add active class to clicked tab and corresponding pane
            $(`#tab-${packingId}`).addClass('active');
            $(`#pane-${packingId}`).addClass('show active');
            
            // Load fields for the selected tab (only if not already loaded)
            loadPackingTypeFieldsForTab(packingId);
            // Ensure global factory fields remain populated across tab switches
            ensureFactoryFieldsPopulated();
            
            // Check if we already have calculation data stored and populate it
            const tabPane = $(`#pane-${packingId}`);
            const storedCalculation = tabPane.data('existing-calculation');

            // Sync per-tab Grade / Colour / Received Type dropdowns from stored values
            const tabGradeId = tabPane.data('grade-id');
            const tabColourId = tabPane.data('colour-id');
            const tabReceivedTypeId = tabPane.data('received-type-id');
            if (tabGradeId) {
                $('#gradeId').val(tabGradeId);
            } else {
                $('#gradeId').val('');
            }
            if (tabColourId) {
                $('#colourId').val(tabColourId);
            } else {
                $('#colourId').val('');
            }
            if (tabReceivedTypeId) {
                $('#receivedTypeId').val(tabReceivedTypeId);
            } else {
                $('#receivedTypeId').val('');
            }
            
            // Check if fields already exist (already loaded)
            const existingFields = tabPane.find('.pck-field');
            const fieldsExist = existingFields.length > 0;
            
            if (fieldsExist) {
                console.log('Fields already exist for tab:', packingId);
                
                // Update radio buttons for this tab
                setTimeout(function() {
                    updateRadioButtonsForActiveTab();
                }, 50);
                
                // Fields exist, check mode and trigger appropriate calculation
                const storedCalc = tabPane.data('existing-calculation');
                const isGradeWeightMode = storedCalc && storedCalc.CALCULATIONMODE == 2;
                
                setTimeout(function() {
                    const hasData = tabPane.find('.pck-field').filter(function() {
                        return $(this).val() && parseFloat($(this).val()) > 0;
                    }).length > 0;
                    
                    if (hasData) {
                        if (isGradeWeightMode) {
                            console.log('Tab switched (Grade Weight) - INSTANT calculation for:', packingId);
                            // Immediate calculation for Grade Weight
                            calculateGradeWeightMode(tabPane);
                        } else {
                            console.log('Tab switched (Packing) - normal calculation for:', packingId);
                            calculateTabTotals(tabPane);
                        }
                    }
                }, isGradeWeightMode ? 0 : 50); // No delay for Grade Weight, 50ms for Packing
            } else {
                // Fields don't exist, need to load and populate
                // NOTE: Don't populate here! The renderPackingTypeFieldsForTab() function
                // will handle population after fields are loaded via AJAX.
                // Calling populate here causes race condition where fields aren't ready yet.
                console.log('Fields need to be loaded. Population will happen after field rendering.');
                
                // If no stored calculation, load from server
                if (!storedCalculation) {
                    console.log('No stored calculation found, loading from server...');
                    loadExistingCalculationForTab(packingId);
                }
                // If stored calculation exists, it will be populated by renderPackingTypeFieldsForTab
            }
        }

        // Handle packing master tab change (backup event handler)
        // NOTE: This is a fallback handler in case Bootstrap's tab event fires
        // The main tab switching is handled by the direct click handler and switchTab() function
        $(document).on('shown.bs.tab', '#packingMasterTabs a[data-toggle="tab"]', function (e) {
            const packingId = $(e.target).data('packing-id');
            console.log('Bootstrap tab event fired for:', packingId);
            if (packingId) {
                // Update radio buttons for this tab
                setTimeout(function() {
                    updateRadioButtonsForActiveTab();
                }, 200);
                // Re-ensure factory fields after tab change
                ensureFactoryFieldsPopulated();
            }
        });

        // Handle direct tab clicks
        $(document).on('click', '#packingMasterTabs .nav-link', function(e) {
            e.preventDefault();
            const packingId = $(this).data('packing-id');
            console.log('Tab clicked:', packingId);
            switchTab(packingId);
            
            // Note: Radio button updates and calculations are handled within switchTab()
            // Just ensure factory fields are populated
            ensureFactoryFieldsPopulated();
        });

        // Handle modal shown event to update radio buttons for initial tab
        $('#productCalculationModal').on('shown.bs.modal', function() {
            console.log('Modal fully shown - updating radio buttons for active tab');
            setTimeout(function() {
                updateRadioButtonsForActiveTab();
                
                // Also ensure production date is set from active tab data
                const activeTab = $('.tab-pane.active');
                if (activeTab.length > 0) {
                    const storedCalculation = activeTab.data('existing-calculation');
                    console.log('Modal shown - checking active tab calculation:', storedCalculation);
                    
                    if (storedCalculation && storedCalculation.PRODDATE) {
                        try {
                            const prodDate = new Date(storedCalculation.PRODDATE);
                            if (!isNaN(prodDate.getTime())) {
                                const formattedDate = prodDate.toISOString().split('T')[0];
                                const dateField = $('#prodDate');
                                
                                console.log('Modal shown - setting date field:', formattedDate);
                                console.log('Date field exists:', dateField.length > 0);
                                
                                if (dateField.length > 0) {
                                    dateField.val(formattedDate);
                                    console.log('Modal shown - date field value after setting:', dateField.val());
                                }
                            }
                        } catch (error) {
                            console.error('Modal shown - error setting date:', error);
                        }
                    } else {
                        console.log('Modal shown - no PRODDATE in stored calculation');
                    }
                }
            }, 500); // Wait for data to be loaded and processed
        });

        // Handle save tab calculation button
        $(document).on('click', '.save-tab-calculation-btn', function() {
            const packingId = $(this).data('packing-id');
            const tabPane = $(`#pane-${packingId}`);
            saveTabCalculation(tabPane, packingId);
        });

        // Handle Next button to move to the next tab
        $(document).on('click', '.next-tab-btn', function() {
            const currentPackingId = $(this).data('packing-id');
            const $tabs = $('#packingMasterTabs .nav-link');
            const index = $tabs.index($(`#tab-${currentPackingId}`));
            if (index === -1) return;
            const nextIndex = index + 1;
            if (nextIndex < $tabs.length) {
                const $nextTab = $tabs.eq(nextIndex);
                const nextPackingId = $nextTab.data('packing-id');
                if (nextPackingId) {
                    switchTab(nextPackingId);
                }
            } else {
                // Optional: loop back to first tab
                const $firstTab = $tabs.first();
                const firstPackingId = $firstTab.data('packing-id');
                if (firstPackingId) {
                    switchTab(firstPackingId);
                }
            }
        });

        // Handle Back button to move to the previous tab
        $(document).on('click', '.back-tab-btn', function() {
            const currentPackingId = $(this).data('packing-id');
            const $tabs = $('#packingMasterTabs .nav-link');
            const index = $tabs.index($(`#tab-${currentPackingId}`));
            if (index === -1) return;
            let prevIndex = index - 1;
            if (prevIndex >= 0) {
                const $prevTab = $tabs.eq(prevIndex);
                const prevPackingId = $prevTab.data('packing-id');
                if (prevPackingId) {
                    switchTab(prevPackingId);
                }
            } else {
                // Optional: loop to the last tab
                const $lastTab = $tabs.last();
                const lastPackingId = $lastTab.data('packing-id');
                if (lastPackingId) {
                    switchTab(lastPackingId);
                }
            }
        });

        // Handle input changes for tab calculations
        $(document).on('input', '.tab-pane input', function() {
            const tabPane = $(this).closest('.tab-pane');
            const calculationMode = $('input[name="calculationMode"]:checked').val();
            
            if (calculationMode === 'gradeweight' && ($(this).hasClass('pck-field') || $(this).hasClass('bkn-field'))) {
                // INSTANT calculation for PCK and BKN fields in Grade Weight mode
                console.log('PCK/BKN field changed in Grade Weight mode - INSTANT calculation');
                calculateGradeWeightMode(tabPane);
            } else {
                console.log('Input changed, triggering calculation for:', tabPane.attr('id'));
                calculateTabTotals(tabPane);
            }
        });
        
        // Add a global function to manually trigger calculations (for debugging)
        window.forceCalculateActiveTab = function() {
            const activeTab = $('.tab-pane.active');
            if (activeTab.length > 0) {
                console.log('Manually triggering calculation for active tab:', activeTab.attr('id'));
                calculateTabTotals(activeTab);
            } else {
                console.log('No active tab found');
            }
        };
        
        // Add a global function to calculate all tabs with data
        window.forceCalculateAllTabs = function() {
            $('.tab-pane').each(function() {
                const tabPane = $(this);
                const hasData = tabPane.find('.pck-field').filter(function() {
                    return $(this).val() && parseFloat($(this).val()) > 0;
                }).length > 0;
                
                if (hasData) {
                    console.log('Force calculating tab:', tabPane.attr('id'));
                    calculateTabTotals(tabPane);
                }
            });
        };
        
        // Add a global function to debug date field issues
        window.debugDateField = function() {
            const dateField = $('#prodDate');
            console.log('=== DATE FIELD DEBUG ===');
            console.log('Date field exists:', dateField.length > 0);
            console.log('Date field value:', dateField.val());
            console.log('Date field visible:', dateField.is(':visible'));
            console.log('Date field HTML:', dateField[0] ? dateField[0].outerHTML : 'Not found');
            
            // Try to set a test date
            if (dateField.length > 0) {
                const testDate = '2025-10-09';
                dateField.val(testDate);
                console.log('Test date set. New value:', dateField.val());
            }
            
            // Check all stored calculations for dates
            $('.tab-pane').each(function() {
                const tabPane = $(this);
                const storedCalculation = tabPane.data('existing-calculation');
                if (storedCalculation) {
                    console.log('Tab', tabPane.attr('id'), 'PRODDATE:', storedCalculation.PRODDATE);
                }
            });
        };
        
        
        // Special handler for Peeled field in Grade Weight mode
        $(document).on('input', '.wastage', function() {
            const calculationMode = $('input[name="calculationMode"]:checked').val();
            if (calculationMode === 'gradeweight') {
                const tabPane = $(this).closest('.tab-pane');
                // INSTANT calculation for Grade Weight mode when Peeled changes
                calculateGradeWeightMode(tabPane);
                console.log('Peeled value changed in Grade Weight mode - INSTANT Factory Weight calculation');
            }
        });

        // Handle calculation mode change
        $(document).on('change', 'input[name="calculationMode"]', function() {
            const mode = $(this).val();
            console.log('=== CALCULATION MODE CHANGE EVENT ===');
            console.log('Mode changed to:', mode);
            
            // Update visual styling
            $('.calculation-mode-section .form-check').removeClass('selected');
            $(this).closest('.form-check').addClass('selected');
            
            // Save the mode to the active tab's stored calculation data
            const activeTab = $('.tab-pane.active');
            if (activeTab.length > 0) {
                const storedCalculation = activeTab.data('existing-calculation');
                if (storedCalculation) {
                    // Update the stored calculation mode
                    storedCalculation.CALCULATIONMODE = mode === 'gradeweight' ? 2 : 1;
                    activeTab.data('existing-calculation', storedCalculation);
                    console.log('Updated stored calculation mode for active tab to:', mode);
                }
            }
            
            // Show/hide fields based on mode
            if (mode === 'gradeweight') {
                // Grade Weight mode: Show Packing Type Details + Slab + Peeled + Factory Weight
                console.log('Switching to Grade Weight mode - showing limited fields');
                
                // Always show Packing Type Details
                $('.packing-fields-container').show();
                
                // Show only Slab field from Slab Calculation
                $('#slab-field').show();
                $('.slab-field').hide(); // Hide other slab calculation fields
                
                // Show Peeled and Factory Weight fields from Total Weight Calculation
                $('#peeled-field').show();
                $('#factory-weight-field').show(); // Show Factory Weight in Grade Weight mode
                $('.weight-field').not('#factory-weight-field').hide(); // Hide other weight calculation fields except Factory Weight
                
            } else {
                // Packing mode: Show all fields
                console.log('Switching to Packing mode - showing all fields');
                
                // Show all fields
                $('.packing-fields-container').show();
                $('#slab-field').show();
                $('.slab-field').show();
                $('#peeled-field').show();
                $('.weight-field').show();
            }
            
            // Recalculate current tab
            if (activeTab.length > 0) {
                console.log('=== RADIO BUTTON CHANGE - TRIGGERING CALCULATION ===');
                console.log('Active tab:', activeTab.attr('id'));
                console.log('Mode:', mode);
                calculateTabTotals(activeTab);
            }
            
            console.log('=== CALCULATION MODE CHANGE EVENT COMPLETED ===');
        });

        // Handle radio button container clicks
        $(document).on('click', '.calculation-mode-section .form-check', function(e) {
            if (e.target.type !== 'radio') {
                $(this).find('input[type="radio"]').prop('checked', true).trigger('change');
            }
        });
        



        // Handle close button clicks
        $(document).on('click', '#productCalculationModal .close, #productCalculationModal [data-dismiss="modal"]', function() {
            closeProductCalculationModal();
        });

        // Prevent closing when clicking on backdrop
        $(document).on('click', '.modal-backdrop', function(e) {
            e.preventDefault();
            e.stopPropagation();
            return false;
        });

        // Prevent closing when clicking outside modal content
        $(document).on('click', '#productCalculationModal', function(e) {
            if (e.target === this) {
                e.preventDefault();
                e.stopPropagation();
                return false;
            }
        });

        function closeProductCalculationModal() {
            // Hide modal using direct method
            $('#productCalculationModal').removeClass('show fade').hide();
            $('.modal-backdrop').remove();
            $('body').removeClass('modal-open');
        }

        // Function to ensure date field is populated in edit mode
        function ensureDateFieldIsPopulated(trandid) {
            console.log('=== ENSURING DATE FIELD IS POPULATED ===');
            const dateField = $('#prodDate');
            
            if (!dateField.length) {
                console.error('Date field not found in DOM');
                return;
            }
            
            if (dateField.val()) {
                console.log('Date field already has value:', dateField.val());
                return;
            }
            
            console.log('Date field is empty, attempting to populate...');
            
            // Try to get date and client factory fields from any stored calculation data
            let foundDate = null;
            let foundFacAvgWgt = null;
            let foundFacAvgCnt = null;
            $('.tab-pane').each(function() {
                const tabPane = $(this);
                const storedCalculation = tabPane.data('existing-calculation');
                
                if (storedCalculation && storedCalculation.PRODDATE && !foundDate) {
                    foundDate = storedCalculation.PRODDATE;
                    console.log('Found date from tab:', tabPane.attr('id'), 'Date:', foundDate);
                }
                if (storedCalculation) {
                    if ((storedCalculation.FACAVGWGT || storedCalculation.FACAVGWGT === 0) && foundFacAvgWgt === null) {
                        foundFacAvgWgt = storedCalculation.FACAVGWGT;
                    }
                    if ((storedCalculation.FACAVGCOUNT || storedCalculation.FACAVGCOUNT === 0) && foundFacAvgCnt === null) {
                        foundFacAvgCnt = storedCalculation.FACAVGCOUNT;
                    }
                }
            });
            
            if (foundDate) {
                try {
                    let formattedDate;
                    
                    // Handle different date formats
                    if (typeof foundDate === 'string') {
                        // If it's already a string in YYYY-MM-DD format, use it directly
                        if (foundDate.match(/^\d{4}-\d{2}-\d{2}$/)) {
                            formattedDate = foundDate;
                        } else {
                            // Parse the string date
                            const prodDate = new Date(foundDate);
                            if (!isNaN(prodDate.getTime())) {
                                formattedDate = prodDate.toISOString().split('T')[0];
                            }
                        }
                    } else {
                        // Handle Date object
                        const prodDate = new Date(foundDate);
                        if (!isNaN(prodDate.getTime())) {
                            formattedDate = prodDate.toISOString().split('T')[0];
                        }
                    }
                    
                    if (formattedDate) {
                        // Clear any existing value first
                        dateField.val('');
                        dateField[0].value = '';
                        
                        // Set the date using multiple methods
                        dateField.val(formattedDate);
                        dateField[0].value = formattedDate;
                        dateField.attr('value', formattedDate);
                        
                        // Force the browser to recognize the change
                        dateField[0].dispatchEvent(new Event('input', { bubbles: true }));
                        dateField[0].dispatchEvent(new Event('change', { bubbles: true }));
                        
                        // Trigger jQuery events
                        dateField.trigger('change');
                        dateField.trigger('input');
                        
                        console.log('Successfully set date field to:', formattedDate);
                        console.log('Final date field value:', dateField.val());
                        
                        // Verify after a short delay
                        setTimeout(function() {
                            console.log('ensureDateFieldIsPopulated verification:', dateField.val());
                        }, 100);
                    }
                    // Also set factory fields if found
                    if (foundFacAvgWgt !== null && $('#facAvgWeight').length) {
                        $('#facAvgWeight').val(foundFacAvgWgt);
                    }
                    if (foundFacAvgCnt !== null && $('#facAvgCount').length) {
                        $('#facAvgCount').val(foundFacAvgCnt);
                    }
                } catch (error) {
                    console.error('Error setting date field:', error);
                }
            } else {
                // If no date found in stored calculations, try to get from server
                console.log('No date found in stored calculations, trying server...');
                $.ajax({
                    url: '@Url.Action("GetProductCalculation", "RawMaterialIntake")',
                    type: 'GET',
                    data: { trandid: trandid, packingId: $('#packingMasterTabs .nav-link').first().data('packing-id') },
                    success: function(data) {
                        if (data.success && data.calculation && data.calculation.PRODDATE) {
                            try {
                                let formattedDate;
                                
                                // Handle different date formats from server
                                if (typeof data.calculation.PRODDATE === 'string') {
                                    // If it's already a string in YYYY-MM-DD format, use it directly
                                    if (data.calculation.PRODDATE.match(/^\d{4}-\d{2}-\d{2}$/)) {
                                        formattedDate = data.calculation.PRODDATE;
                                    } else {
                                        // Parse the string date
                                        const prodDate = new Date(data.calculation.PRODDATE);
                                        if (!isNaN(prodDate.getTime())) {
                                            formattedDate = prodDate.toISOString().split('T')[0];
                                        }
                                    }
                                } else {
                                    // Handle Date object
                                    const prodDate = new Date(data.calculation.PRODDATE);
                                    if (!isNaN(prodDate.getTime())) {
                                        formattedDate = prodDate.toISOString().split('T')[0];
                                    }
                                }
                                
                                if (formattedDate) {
                                    // Clear any existing value first
                                    dateField.val('');
                                    dateField[0].value = '';
                                    
                                    dateField.val(formattedDate);
                                    dateField[0].value = formattedDate;
                                    dateField.attr('value', formattedDate);
                                    
                                    // Force the browser to recognize the change
                                    dateField[0].dispatchEvent(new Event('input', { bubbles: true }));
                                    dateField[0].dispatchEvent(new Event('change', { bubbles: true }));
                                    
                                    dateField.trigger('change');
                                    dateField.trigger('input');
                                    
                                    console.log('Set date from server:', formattedDate);
                                    console.log('Server date field verification:', dateField.val());
                                }
                                // Also set factory fields from server response if present
                                if (data.calculation) {
                                    if ((data.calculation.FACAVGWGT || data.calculation.FACAVGWGT === 0) && $('#facAvgWeight').length) {
                                        $('#facAvgWeight').val(data.calculation.FACAVGWGT);
                                    }
                                    if ((data.calculation.FACAVGCOUNT || data.calculation.FACAVGCOUNT === 0) && $('#facAvgCount').length) {
                                        $('#facAvgCount').val(data.calculation.FACAVGCOUNT);
                                    }
                                }
                            } catch (error) {
                                console.error('Error setting date from server:', error);
                            }
                        }
                    },
                    error: function() {
                        console.log('Error getting date from server');
                    }
                });
            }
        }


        function getMultiplierFromLabel(label) {
            if (!label) return 1;
            
            // Extract numbers from labels like "U - 5", "U - 10", "51-60", "151-200", etc.
            const numbers = label.match(/\d+/g);
            
            if (numbers && numbers.length === 1) {
                // Single number like "U - 5" -> use 5
                return parseInt(numbers[0]);
            } else if (numbers && numbers.length === 2) {
                // Range like "51-60" -> use the last/highest value (60)
                return parseInt(numbers[1]);
            }
            
            return 1; // Default fallback
        }

        // Helper to detect BKN / OTHERS fields in a consistent way
        function isBknLabel(fieldLabelUpper) {
            if (!fieldLabelUpper) return false;
            const upper = fieldLabelUpper.toUpperCase().trim();
            return upper === 'BKN' || upper === 'BROKEN' || upper.indexOf('BKN') !== -1;
        }

        function isOthersLabel(fieldLabelUpper) {
            if (!fieldLabelUpper) return false;
            const upper = fieldLabelUpper.toUpperCase().trim();
            return upper === 'OTHERS' || upper === 'OTHER' || upper.indexOf('OTHERS') !== -1;
        }

        // Helper to control visual order of packing fields inside the P-button popup
        // Head On style: U-5, U-7, U-10, U-15, 10-20, 20-30, 30/40, 40/50, 50/60, then BKN and OTHERS
        // Works generically for Head Less / Easy Peel etc. based on label text
        function getPackingFieldOrderKey(labelUpper) {
            if (!labelUpper) return 1000;
            const upper = labelUpper.toUpperCase().trim();

            // Always keep BKN and OTHERS at the end
            if (isBknLabel(upper)) return 9000;
            if (isOthersLabel(upper)) return 9001;

            // Normalise common formats: remove spaces/colons so "U - 5" -> "U-5", "30 / 40" -> "30/40"
            const normalized = upper.replace(/\s+/g, '').replace(/:/g, '');

            const orderMap = {
                'U-5': 1,
                'U-7': 2,
                'U-10': 3,
                'U-15': 4,
                '10-20': 5,
                '20-30': 6,
                '30/40': 7,
                '30-40': 7,
                '40/50': 8,
                '40-50': 8,
                '50/60': 9,
                '50-60': 9
            };

            if (orderMap.hasOwnProperty(normalized)) {
                return orderMap[normalized];
            }

            // Fallback: use highest numeric value found in the label so smaller sizes come first
            const numbers = upper.match(/\d+/g);
            if (numbers && numbers.length > 0) {
                const max = Math.max.apply(null, numbers.map(function(n) { return parseInt(n, 10) || 0; }));
                return 100 + max;
            }

            // Default middle position for labels without numbers
            return 500;
        }

        function loadPackingTypeFieldsForTab(packingId) {
            // Check if fields are already loaded for this tab
            const container = $(`#pane-${packingId} .packing-fields-container`);
            const existingFields = container.find('.pck-field');
            
            if (existingFields.length > 0) {
                console.log('Fields already exist for tab:', packingId, '- skipping reload');
                return; // Don't reload if fields already exist
            }
            
            console.log('Loading fields for tab:', packingId);
            $.ajax({
                url: '@Url.Action("GetPackingTypeFields", "RawMaterialIntake")',
                type: 'GET',
                data: { packingId: packingId },
                success: function(data) {
                    if (data.success) {
                        renderPackingTypeFieldsForTab(data.fields, packingId);
                    } else {
                        container.html('<div class="col-12"><div class="alert alert-warning">No packing type fields found.</div></div>');
                    }
                },
                error: function() {
                    container.html('<div class="col-12"><div class="alert alert-danger">Error loading packing type fields.</div></div>');
                }
            });
        }

        function renderPackingTypeFieldsForTab(fields, packingId) {
            let html = '';

            // Map each packing type (by PACKTMID) to its PCK index based on
            // original database order (PACKTMCODE), skipping BKN / OTHERS.
            // This keeps PCK1..PCK17 aligned with server-side calculations
            // even though we visually sort the fields for a nicer layout.
            const dbIndexById = {};
            let dbIndex = 1;
            (fields || []).forEach(function(field) {
                const labelUpper = (field.label || '').toUpperCase().trim();
                if (!isBknLabel(labelUpper) && !isOthersLabel(labelUpper)) {
                    dbIndexById[field.id] = dbIndex++;
                }
            });

            let fallbackIndex = dbIndex; // Fallback for any unexpected field

            // Sort fields into a logical slab order (U-5, U-7, ..., 50/60, then BKN and OTHERS)
            const sortedFields = (fields || []).slice().sort(function(a, b) {
                const aLabel = (a.label || '').toUpperCase().trim();
                const bLabel = (b.label || '').toUpperCase().trim();
                const aKey = getPackingFieldOrderKey(aLabel);
                const bKey = getPackingFieldOrderKey(bLabel);
                if (aKey === bKey) {
                    return aLabel.localeCompare(bLabel);
                }
                return aKey - bKey;
            });
            
            sortedFields.forEach(function(field, index) {
                const colClass = sortedFields.length <= 6 ? 'col-md-4' : 'col-md-3';
                const fieldLabel = (field.label || '').toUpperCase().trim();
                
                // Check if this field is BKN (Broken)
                const isBKNField = isBknLabel(fieldLabel);
                
                // Check if this field is OTHERS
                const isOTHERSField = isOthersLabel(fieldLabel);
                
                if (isBKNField) {
                    // Create BKN field with special class
                    html += `
                        <div class="${colClass} mb-3">
                            <div class="form-group">
                                <label for="bkn_${packingId}">${field.label}:</label>
                                <input type="number" class="form-control bkn-field" id="bkn_${packingId}" min="0" step="0.001" placeholder="0.000" data-multiplier="${getMultiplierFromLabel(field.label)}">
                            </div>
                        </div>
                    `;
                } else if (isOTHERSField) {
                    // Create OTHERS field with special class and bold label text
                    html += `
                        <div class="${colClass} mb-3">
                            <div class="form-group">
                                <label for="others_${packingId}"><strong>${field.label}:</strong></label>
                                <input type="number" class="form-control others-field" id="others_${packingId}" min="0" step="0.001" placeholder="0.000" data-multiplier="${getMultiplierFromLabel(field.label)}">
                            </div>
                        </div>
                    `;
                } else {
                    // Create regular PCK field, but use DB-based PCK index for saving
                    const pckIndex = dbIndexById[field.id] || (fallbackIndex++);
                    html += `
                        <div class="${colClass} mb-3">
                            <div class="form-group">
                                <label for="pck${pckIndex}_${packingId}">${field.label}:</label>
                                <input type="number" class="form-control pck-field" id="pck${pckIndex}_${packingId}" min="0" step="0.001" placeholder="0.000" data-multiplier="${getMultiplierFromLabel(field.label)}" data-pck-index="${pckIndex}">
                            </div>
                        </div>
                    `;
                }
            });
            
            const container = $(`#pane-${packingId} .packing-fields-container`);
            container.html(html);
            
            // Reset calculations for this tab
            const tabPane = $(`#pane-${packingId}`);
            tabPane.find('.calculation-result').text('0.000');
            tabPane.find('.total-counts').text('0');
            
            // Check if we have stored calculation data for this tab
            const storedCalculation = tabPane.data('existing-calculation');
            if (storedCalculation && Object.keys(storedCalculation).length > 0) {
                console.log('Found stored calculation data in loadPackingTypeFieldsForTab, populating fields for packingId:', packingId);
                setTimeout(function() {
                    // Double-check data still exists before populating
                    const currentCalc = tabPane.data('existing-calculation');
                    if (currentCalc && Object.keys(currentCalc).length > 0) {
                        populateTabCalculation(currentCalc, packingId);
                    }
                }, 300); // Increased to 300ms to ensure fields are ready
            } else {
                console.log('No stored calculation data found in loadPackingTypeFieldsForTab for packingId:', packingId);
            }
            
            // Also trigger calculation on input changes for this tab
            setTimeout(function() {
                tabPane.find('.pck-field, .bkn-field, .others-field, .pounds-value, .yield-percent, .per-kg-weight, .wastage').on('input', function() {
                    calculateTabTotals(tabPane);
                });
            }, 300);
        }

        function loadExistingCalculationForTab(packingId) {
            const trandid = $('#productCalculationModal').data('trandid');
            
            if (!trandid) {
                console.log('No TRANDID available yet, skipping calculation load');
                return;
            }
            
            // OPTIMIZED: Check if calculation is already cached from batch load
            const tabPane = $(`#pane-${packingId}`);
            const cachedCalculation = tabPane.data('existing-calculation');
            
            if (cachedCalculation && Object.keys(cachedCalculation).length > 0) {
                console.log('Using cached calculation for packingId:', packingId);
                return; // Data already loaded, no need for AJAX call
            }
            
            console.log('Loading calculation from server for trandid:', trandid, 'packingId:', packingId);
            
            $.ajax({
                url: '@Url.Action("GetProductCalculation", "RawMaterialIntake")',
                type: 'GET',
                data: { trandid: trandid, packingId: packingId },
                success: function(data) {
                    console.log('Calculation response for packingId', packingId, ':', data);
                    if (data.success && data.calculation) {
                        // Store the calculation data for later population
                        $(`#pane-${packingId}`).data('existing-calculation', data.calculation);
                        console.log('Stored calculation data for packingId:', packingId);
                        // If global fields are empty, populate from this tab's data too
                        if ($('#facAvgWeight').length && !$('#facAvgWeight').val() && (data.calculation.FACAVGWGT || data.calculation.FACAVGWGT === 0)) {
                            $('#facAvgWeight').val(data.calculation.FACAVGWGT);
                        }
                        if ($('#facAvgCount').length && !$('#facAvgCount').val() && (data.calculation.FACAVGCOUNT || data.calculation.FACAVGCOUNT === 0)) {
                            $('#facAvgCount').val(data.calculation.FACAVGCOUNT);
                        }
                        
                        // If this is the active tab, populate immediately after a delay
                        const isActiveTab = $(`#pane-${packingId}`).hasClass('active');
                        
                        if (isActiveTab) {
                            console.log('This is the active tab, populating data...');
                            setTimeout(function() {
                                populateTabCalculation(data.calculation, packingId);
                                
                                // Also update radio buttons for the active tab after population
                                setTimeout(function() {
                                    console.log('Updating radio buttons after active tab population');
                                    updateRadioButtonsForActiveTab();
                                    
                                    // Ensure date is set after all population is complete
                                    if (data.calculation && data.calculation.PRODDATE) {
                                        try {
                                            const prodDate = new Date(data.calculation.PRODDATE);
                                            if (!isNaN(prodDate.getTime())) {
                                                const formattedDate = prodDate.toISOString().split('T')[0];
                                                const dateField = $('#prodDate');
                                                
                                                if (dateField.length > 0 && !dateField.val()) {
                                                    dateField.val(formattedDate);
                                                    console.log('Final date set after population:', formattedDate);
                                                }
                                            }
                                        } catch (error) {
                                            console.error('Error in final date setting:', error);
                                        }
                                    }
                                }, 200);
                            }, 800); // Wait for fields to be fully loaded
                        }
                        // Stabilize global factory fields regardless of active tab
                        ensureFactoryFieldsPopulated();
                    } else {
                        console.log('No existing calculation found for packing master:', packingId);
                    }
                },
                error: function() {
                    console.log('Error loading existing calculation for tab:', packingId);
                }
            });
        }

        function populateTabCalculation(calculation, packingId) {
            const tabPane = $(`#pane-${packingId}`);
            
            console.log('=== POPULATING TAB CALCULATION ===');
            console.log('Packing ID:', packingId);
            console.log('Tab pane found:', tabPane.length > 0);
            console.log('Calculation data:', calculation);
            
            if (!calculation) {
                console.log('ERROR: No calculation data provided');
                return;
            }
            
            // Populate packing fields (no setTimeout - timing controlled by caller)
            console.log('Starting field population...');
            for (let i = 1; i <= 17; i++) {
                const val = calculation['PCK' + i];
                const fieldId = `#pck${i}_${packingId}`;
                const field = tabPane.find(fieldId);
                
                if (val !== null && val !== undefined && val > 0) { // Only log non-zero values
                    console.log(`PCK${i}: value=${val}, fieldId=${fieldId}, fieldExists=${field.length > 0}`);
                }
                
                if (val !== null && val !== undefined && field.length > 0) {
                    field.val(val);
                    if (val > 0) { // Only log successful sets for non-zero values
                        console.log(`✓ Set ${fieldId} to ${val}`);
                    }
                }
            }
            
            // Populate tab-specific fields only (NOT global fields - those are set on modal open)
            tabPane.find('.pounds-value').val(calculation.PNDSVALUE || '');
            tabPane.find('.yield-percent').val(calculation.YELDPERCENT || '');
            tabPane.find('.per-kg-weight').val(calculation.KGWGT || '');
            tabPane.find('.wastage').val(calculation.WASTEWGT || '');
            
            // Populate BKN field (tab-specific)
            if (calculation.BKN !== null && calculation.BKN !== undefined) {
                tabPane.find('.bkn-field').val(calculation.BKN);
                console.log('Set BKN field to:', calculation.BKN);
            }
            
            // Populate OTHERS field (tab-specific)
            if (calculation.OTHERS !== null && calculation.OTHERS !== undefined) {
                tabPane.find('.others-field').val(calculation.OTHERS);
                console.log('Set OTHERS field to:', calculation.OTHERS);
            }
            
            // NOTE: Global fields (date, factory fields, dropdowns) are set once on modal open
            // Don't set them here to avoid overwriting on tab switches
            
            // INSTANT Grade Weight calculation if this is Grade Weight mode
            const isGradeWeightMode = calculation.CALCULATIONMODE == 2;
            if (isGradeWeightMode) {
                console.log('=== INSTANT GRADE WEIGHT CALCULATION AFTER FIELD POPULATION ===');
                calculateGradeWeightMode(tabPane);
            }
            
            console.log('Tab-specific fields populated for packing ID:', packingId);
            
            // Store the calculation ID for updates
            tabPane.attr('data-calculation-id', calculation.TRANPID || 0);
            
            // Set calculation mode AFTER all fields are populated
            console.log('Raw CALCULATIONMODE from database:', calculation.CALCULATIONMODE);
            const frontendMode = calculation.CALCULATIONMODE == 2 ? 'gradeweight' : 'packing'; // 1=packing, 2=gradeweight
            console.log('Setting calculation mode to:', frontendMode, '(backend value:', calculation.CALCULATIONMODE, ')');
            
            // Set radio button without triggering change event initially
            $(`input[name="calculationMode"][value="${frontendMode}"]`).prop('checked', true);
            $('.calculation-mode-section .form-check').removeClass('selected');
            $(`input[name="calculationMode"][value="${frontendMode}"]`).closest('.form-check').addClass('selected');
            
            // Apply the form layout based on mode
            applyModeLayout(frontendMode);
            
            // Trigger calculations based on mode
            if (frontendMode === 'gradeweight') {
                // Grade Weight mode - IMMEDIATE calculation (no delay)
                console.log('=== INSTANT GRADE WEIGHT CALCULATION ===');
                calculateGradeWeightMode(tabPane);
            } else {
                // Packing mode - trigger calculation after a short delay
                setTimeout(function() {
                    console.log('=== TRIGGERING CALCULATIONS FOR EDIT MODE ===');
                    calculateTabTotals(tabPane);
                }, 100);
            }
            
            console.log('=== POPULATION COMPLETE ===');
        }

        function updateRadioButtonsForActiveTab() {
            const activeTab = $('.tab-pane.active');
            if (activeTab.length > 0) {
                const storedCalculation = activeTab.data('existing-calculation');
                if (storedCalculation && storedCalculation.CALCULATIONMODE) {
                    const frontendMode = storedCalculation.CALCULATIONMODE == 2 ? 'gradeweight' : 'packing';
                    console.log('Updating radio buttons for active tab to:', frontendMode);
                    
                    // Update radio button selection
                    $(`input[name="calculationMode"][value="${frontendMode}"]`).prop('checked', true);
                    $('.calculation-mode-section .form-check').removeClass('selected');
                    $(`input[name="calculationMode"][value="${frontendMode}"]`).closest('.form-check').addClass('selected');
                    
                    // Apply the layout
                    applyModeLayout(frontendMode);
                } else {
                    // Default to packing mode
                    $('input[name="calculationMode"][value="packing"]').prop('checked', true);
                    $('.calculation-mode-section .form-check').removeClass('selected');
                    $('input[name="calculationMode"][value="packing"]').closest('.form-check').addClass('selected');
                    applyModeLayout('packing');
                }
            }
        }

        function applyModeLayout(mode) {
            console.log('Applying mode layout:', mode);
            
            if (mode === 'gradeweight') {
                // Grade Weight mode: Show Packing Type Details + Slab + Peeled + Factory Weight
                console.log('Applying Grade Weight mode layout');
                
                // Always show Packing Type Details
                $('.packing-fields-container').show();
                
                // Show only Slab field from Slab Calculation
                $('#slab-field').show();
                $('.slab-field').hide(); // Hide other slab calculation fields
                
                // Show Peeled and Factory Weight fields from Total Weight Calculation
                $('#peeled-field').show();
                $('#factory-weight-field').show(); // Show Factory Weight in Grade Weight mode
                $('.weight-field').not('#factory-weight-field').hide(); // Hide other weight calculation fields except Factory Weight
                
            } else {
                // Packing mode: Show all fields
                console.log('Applying Packing mode layout');
                
                // Show all fields
                $('.packing-fields-container').show();
                $('#slab-field').show();
                $('.slab-field').show();
                $('#peeled-field').show();
                $('.weight-field').show();
            }
        }

        function calculateTabTotals(tabPane) {
            // Check calculation mode from radio buttons
            const calculationMode = $('input[name="calculationMode"]:checked').val();
            console.log('=== calculateTabTotals called ===');
            console.log('Calculation mode:', calculationMode);
            console.log('Tab pane ID:', tabPane.attr('id'));
            console.log('Tab pane exists:', tabPane.length > 0);
            
            if (!tabPane || tabPane.length === 0) {
                console.log('ERROR: No tab pane provided to calculateTabTotals');
                return;
            }
            
            if (calculationMode === 'gradeweight') {
                // Grade Weight mode: Fast calculation
                calculateGradeWeightMode(tabPane);
            } else {
                // Normal Packing mode: Full calculations
                console.log('Calling Packing mode calculation...');
                calculatePackingMode(tabPane);
            }
            console.log('=== calculateTabTotals completed ===');
        }

        function calculateGradeWeightMode(tabPane) {
            // Fast calculation for Grade Weight mode - minimal logging
            let slabValue = 0;
            
            // Optimized PCK field calculation
            tabPane.find('.pck-field').each(function() {
                const val = parseFloat(this.value) || 0;
                slabValue += val;
            });
            
            // Add BKN field to slab calculation
            tabPane.find('.bkn-field').each(function() {
                const val = parseFloat(this.value) || 0;
                slabValue += val;
            });
            
            // Add OTHERS field to slab calculation
            tabPane.find('.others-field').each(function() {
                const val = parseFloat(this.value) || 0;
                slabValue += val;
            });
            
            // Update Slab display immediately
            tabPane.find('.total-counts').text(slabValue.toFixed(3));
            
            // Get Peeled value (wastage field)
            const peeledValue = parseFloat(tabPane.find('.wastage').val()) || 0;
            
            // Calculate Factory Weight: Slab + Peeled
            const factoryWeight = slabValue + peeledValue;
            
            // Update Factory Weight display
            tabPane.find('.factory-weight').text(factoryWeight.toFixed(3));
            
            // Clear other fields efficiently using a single selector (excluding factory-weight)
            const fieldsToReset = '.avg-pack-value, .total-pounds, .total-yield-counts, .pck-kg-weight, .waste-p-weight';
            tabPane.find(fieldsToReset).text('0.000');
        }

        function calculatePackingMode(tabPane) {
            console.log('=== CALCULATING PACKING MODE ===');
            console.log('Tab pane ID:', tabPane.attr('id'));
            
            // Calculate TOPCK (sum of all PCK fields + BKN field) for this tab
            let topck = 0;
            const pckFields = tabPane.find('.pck-field');
            console.log('PCK fields found in packing mode:', pckFields.length);
            
            // Debug: List all input fields in the tab
            console.log('All inputs in tab:');
            tabPane.find('input').each(function() {
                const val = $(this).val();
                if (val && val !== '0' && val !== '0.000') {
                    console.log('Input:', $(this).attr('id'), 'Value:', val, 'Class:', $(this).attr('class'));
                }
            });
            
            // Sum all PCK fields
            pckFields.each(function() {
                const val = parseFloat($(this).val()) || 0;
                topck += val;
                console.log('PCK field:', $(this).attr('id'), 'Value:', val, 'Raw value:', $(this).val());
            });
            
            // Add BKN field to TOPCK calculation
            const bknField = tabPane.find('.bkn-field');
            if (bknField.length > 0) {
                const bknVal = parseFloat(bknField.val()) || 0;
                topck += bknVal;
                console.log('BKN field:', bknField.attr('id'), 'Value:', bknVal, 'Raw value:', bknField.val());
            }
            
            // Add OTHERS field to TOPCK calculation
            const othersField = tabPane.find('.others-field');
            if (othersField.length > 0) {
                const othersVal = parseFloat(othersField.val()) || 0;
                topck += othersVal;
                console.log('OTHERS field:', othersField.attr('id'), 'Value:', othersVal, 'Raw value:', othersField.val());
            }
            
            console.log('Total PCK + BKN + OTHERS (TOPCK):', topck);
            tabPane.find('.total-counts').text(topck.toFixed(3)); // Show 3 decimal places

            if (topck === 0) {
                console.log('TOPCK is 0, setting all calculations to 0.000');
                tabPane.find('.calculation-result').text('0.000');
                return;
            }

            // Calculate PCKLVALUE for this tab
            let pcklValue = 0;
            // Include PCK fields
            tabPane.find('.pck-field').each(function() {
                const val = parseFloat($(this).val()) || 0;
                if (val > 0) {
                    const multiplier = parseFloat($(this).attr('data-multiplier')) || 1;
                    pcklValue += val * multiplier;
                }
            });
            // Include BKN field
            tabPane.find('.bkn-field').each(function() {
                const val = parseFloat($(this).val()) || 0;
                if (val > 0) {
                    const multiplier = parseFloat($(this).attr('data-multiplier')) || 1;
                    pcklValue += val * multiplier;
                }
            });
            // Include OTHERS field
            tabPane.find('.others-field').each(function() {
                const val = parseFloat($(this).val()) || 0;
                if (val > 0) {
                    const multiplier = parseFloat($(this).attr('data-multiplier')) || 1;
                    pcklValue += val * multiplier;
                }
            });

            // Calculate AVGPCKVALUE
            const avgPckValue = pcklValue / topck;
            tabPane.find('.avg-pack-value').text(avgPckValue.toFixed(3));

            // Calculate TOTALPNDS
            const poundsValue = parseFloat(tabPane.find('.pounds-value').val()) || 0;
            const totalPounds = avgPckValue * poundsValue;
            tabPane.find('.total-pounds').text(totalPounds.toFixed(3));

            // Calculate TOTALYELDCOUNTS
            const yieldPercent = parseFloat(tabPane.find('.yield-percent').val()) || 0;
            const totalYieldCounts = totalPounds * (yieldPercent / 100);
            tabPane.find('.total-yield-counts').text(totalYieldCounts.toFixed(3));

            // Calculate PCKKGWGT
            const perKgWeight = parseFloat(tabPane.find('.per-kg-weight').val()) || 0;
            const pckKgWeight = perKgWeight * topck;
            tabPane.find('.pck-kg-weight').text(pckKgWeight.toFixed(3));

            // Calculate WASTEPWGT
            const wastage = parseFloat(tabPane.find('.wastage').val()) || 0;
            const wastePWeight = pckKgWeight + wastage;
            tabPane.find('.waste-p-weight').text(wastePWeight.toFixed(3));

            // Calculate FACTORYWGT
            if (yieldPercent > 0) {
                const factoryWeight = wastePWeight / (yieldPercent / 100);
                tabPane.find('.factory-weight').text(factoryWeight.toFixed(3));
            } else {
                tabPane.find('.factory-weight').text('0.000');
            }
        }

        function saveTabCalculation(tabPane, packingId) {
            const trandid = $('#productCalculationModal').data('trandid');
            const calculationId = tabPane.attr('data-calculation-id') || 0;

            console.log('Saving calculation for trandid:', trandid, 'packingId:', packingId);

            // Get calculation mode
            const calculationMode = $('input[name="calculationMode"]:checked').val();
            console.log('Saving in mode:', calculationMode);
            
            // Ensure calculations are up-to-date before saving
            if (calculationMode === 'gradeweight') {
                console.log('Grade Weight mode - ensuring Factory Weight is calculated before save');
                calculateGradeWeightMode(tabPane);
            } else {
                calculateTabTotals(tabPane);
            }

            // Validate production date
            const prodDate = $('#prodDate').val();
            if (!prodDate) {
                alert('Please select a production date before saving.');
                return;
            }

            // Validate required dropdowns (per-tab Grade / Colour / Received Type)
            const gradeVal = $('#gradeId').val();
            const colourVal = $('#colourId').val();
            const receivedTypeVal = $('#receivedTypeId').val();
            if (!gradeVal || !colourVal || !receivedTypeVal) {
                alert('Please select Grade, Production Colour and Received Type before saving this tab.');
                return;
            }

            // Collect all form data for this tab
                const formData = {
                TRANPID: calculationId,
                TRANDID: trandid,
                TRANMID: @Model.TRANMID,
                PACKMID: packingId,
                PNDSVALUE: parseFloat(tabPane.find('.pounds-value').val()) || 0,
                YELDPERCENT: parseFloat(tabPane.find('.yield-percent').val()) || 0,
                KGWGT: parseFloat(tabPane.find('.per-kg-weight').val()) || 0,
                WASTEWGT: parseFloat(tabPane.find('.wastage').val()) || 0,
                PRODDATE: prodDate,  // Add production date
                CalculationMode: calculationMode,  // Add calculation mode to form data
                GRADEID: gradeVal || null,  // Add Grade dropdown
                PCLRID: colourVal || null,  // Add Production Colour dropdown
                RCVDTID: receivedTypeVal || null,  // Add Received Type dropdown
                BKN: parseFloat(tabPane.find('.bkn-field').val()) || null,  // Add BKN field
                OTHERS: parseFloat(tabPane.find('.others-field').val()) || null,  // Add OTHERS field
                
                // Add calculated values from display fields
                TOPCK: parseFloat(tabPane.find('.total-counts').text()) || 0,
                PCKLVALUE: parseFloat(tabPane.find('.total-pack-value').text()) || 0,
                AVGPCKVALUE: parseFloat(tabPane.find('.avg-pack-value').text()) || 0,
                TOTALPNDS: parseFloat(tabPane.find('.total-pounds').text()) || 0,
                TOTALYELDCOUNTS: parseFloat(tabPane.find('.total-yield-counts').text()) || 0,
                PCKKGWGT: parseFloat(tabPane.find('.pck-kg-weight').text()) || 0,
                WASTEPWGT: parseFloat(tabPane.find('.waste-p-weight').text()) || 0,
                FACTORYWGT: parseFloat(tabPane.find('.factory-weight').text()) || 0,  // Factory Weight calculation
                FACAVGWGT: parseFloat($('#facAvgWeight').val()) || 0,
                FACAVGCOUNT: parseFloat($('#facAvgCount').val()) || 0
            };
            
            // Debug: Log the Factory Weight value being saved
            console.log('Factory Weight value being saved:', formData.FACTORYWGT);
            console.log('Factory Weight display text:', tabPane.find('.factory-weight').text());
            console.log('Production date being saved:', formData.PRODDATE);

            // Add PCK fields for this tab
            console.log('Looking for PCK fields in tab:', packingId);
            const pckFields = tabPane.find('.pck-field');
            console.log('Found PCK fields:', pckFields.length);
            
            pckFields.each(function() {
                const pckIndex = $(this).data('pck-index');
                const inputValue = $(this).val();
                const value = inputValue && inputValue.trim() !== '' ? parseFloat(inputValue) : null;
                const fieldId = $(this).attr('id');
                formData['PCK' + pckIndex] = value;
                console.log(`PCK${pckIndex}: value=${value}, fieldId=${fieldId}, inputValue='${inputValue}'`);
            });
            
            // Also check if we have any PCK fields at all
            if (pckFields.length === 0) {
                console.log('No PCK fields found! Checking all inputs in tab...');
                tabPane.find('input').each(function() {
                    console.log('Found input:', $(this).attr('id'), 'class:', $(this).attr('class'), 'value:', $(this).val());
                });
            }

            console.log('Form data being sent:', formData);

            $.ajax({
                url: '@Url.Action("SaveProductCalculation", "RawMaterialIntake")',
                type: 'POST',
                data: formData,
                success: function(response) {
                    console.log('Save response:', response);
                    if (response.success) {
                        // Get the packing master name from the tab text
                        const packingMasterName = $(`#tab-${packingId}`).text().trim();
                        alert(`Calculation saved successfully for ${packingMasterName}!`);
                        if (response.tranpid) {
                            tabPane.attr('data-calculation-id', response.tranpid);
                            console.log('Updated calculation ID:', response.tranpid);
                        }

                        // Update per-tab stored values so future tab switches keep their own Grade/Colour/Received Type
                        tabPane.data('grade-id', gradeVal);
                        tabPane.data('colour-id', colourVal);
                        tabPane.data('received-type-id', receivedTypeVal);
                        const existingCalc = tabPane.data('existing-calculation') || {};
                        existingCalc.GRADEID = parseInt(gradeVal || 0);
                        existingCalc.PCLRID = parseInt(colourVal || 0);
                        existingCalc.RCVDTID = parseInt(receivedTypeVal || 0);
                        tabPane.data('existing-calculation', existingCalc);
                        
                        // Update the weight column for this product row
                        updateFactoryWeightDisplay(trandid);
                    } else {
                        alert('Error: ' + (response.message || 'Failed to save calculation'));
                    }
                },
                error: function(xhr, status, error) {
                    console.log('Save error:', xhr.responseText);
                    alert('Error saving calculation: ' + error);
                }
            });
        }

        function saveProductCalculation() {
            // This function is no longer used - individual tabs have their own save buttons
            alert('Please use the individual "Save [Packing Master] Calculation" buttons for each tab.');
        }

        // Function to update factory weight display in the product table
        function updateFactoryWeightDisplay(trandid) {
            $.ajax({
                url: '@Url.Action("GetFactoryWeight", "RawMaterialIntake")',
                type: 'GET',
                data: { trandid: trandid },
                success: function(response) {
                    if (response.success) {
                        // Find the row with this TRANDID and update the weight display
                        var $tableBody = $('#detailsTable tbody');
                        $tableBody.children('tr').each(function() {
                            var rowTrandid = $(this).data('trandid');
                            if (rowTrandid == trandid) {
                                var weightDisplay = $(this).find('.factory-weight-display');
                                if (response.factoryWeight > 0) {
                                    var displayText = parseFloat(response.factoryWeight).toFixed(3) + ' KG';
                                    weightDisplay.text(displayText)
                                                .removeClass('text-muted')
                                                .addClass('text-success font-weight-bold');
                                } else {
                                    weightDisplay.text('-').removeClass('text-success font-weight-bold').addClass('text-muted');
                                }
                                
                                // Update total weights after individual weight is updated
                                updateTotalWeights();
                            }
                        });
                    }
                },
                error: function(xhr, status, error) {
                    console.log('Error getting factory weight for TRANDID:', trandid, 'Error:', error);
                }
            });
        }

        // Function to load factory weights for all existing rows
        function loadAllFactoryWeights() {
            var $tableBody = $('#detailsTable tbody');
            
            $tableBody.children('tr').each(function(index) {
                var trandid = $(this).data('trandid');
                if (trandid > 0) {
                    updateFactoryWeightDisplay(trandid);
                }
            });
        }

        // Function to calculate and update total weights
        function updateTotalWeights() {
            var totalWeight = 0;
            var $tableBody = $('#detailsTable tbody');
            
            $tableBody.children('tr').each(function() {
                var weightText = $(this).find('.factory-weight-display').text();
                if (weightText && weightText !== '-') {
                    // Extract numeric value from "X.XXX KG" format
                    var weightValue = parseFloat(weightText.replace(' KG', ''));
                    if (!isNaN(weightValue)) {
                        totalWeight += weightValue;
                    }
                }
            });
            
            // Update the total display
            $('#totalWeightDisplay').text(totalWeight.toFixed(3) + ' KG');
        }

        // Production button click handler
        $(document).on('click', '#productionBtn', function(e) {
            e.preventDefault();
            console.log('Production button clicked!');
            openProductionModal();
        });

        // Production modal close handlers
        $(document).on('click', '#productionModal .close, #productionModal [data-dismiss="modal"]', function() {
            closeProductionModal();
        });

        function closeProductionModal() {
            $('#productionModal').modal('hide');
        }

        function openProductionModal() {
            console.log('Opening Production Modal');
            
            try {
                // Check if modal exists
                if ($('#productionModal').length === 0) {
                    alert('Production modal not found in DOM!');
                    return;
                }
                
                // Get supplier name from the correct dropdown
                var supplierName = 'Not Selected';
                
                // Method 1: Try the actual supplier dropdown (supplierDropdown)
                var selectedText = $('#supplierDropdown option:selected').text();
                if (selectedText && selectedText !== '-- Select Supplier --' && selectedText.trim() !== '') {
                    supplierName = selectedText.trim();
                } else {
                    // Method 2: Try by selected value from supplierDropdown
                    var selectedValue = $('#supplierDropdown').val();
                    if (selectedValue && selectedValue !== '') {
                        var optionText = $('#supplierDropdown option[value="' + selectedValue + '"]').text();
                        if (optionText && optionText !== '-- Select Supplier --') {
                            supplierName = optionText.trim();
                        }
                    }
                }
                
                // Method 3: Try Select2 if it's being used
                if (supplierName === 'Not Selected') {
                    try {
                        var select2Text = $('#supplierDropdown').select2('data')[0];
                        if (select2Text && select2Text.text && select2Text.text !== '-- Select Supplier --') {
                            supplierName = select2Text.text.trim();
                        }
                    } catch (e) {
                        // Select2 not available or not initialized
                    }
                }
                
                // Method 4: Fallback to any visible supplier text
                if (supplierName === 'Not Selected') {
                    var visibleSupplier = $('#supplierDropdown').find('option:selected').text();
                    if (visibleSupplier && visibleSupplier !== '-- Select Supplier --' && visibleSupplier.trim() !== '') {
                        supplierName = visibleSupplier.trim();
                    }
                }
                
                console.log('Supplier detection - Selected Value:', $('#supplierDropdown').val(), 'Selected Text:', selectedText, 'Final Name:', supplierName);
                var clientWeight = parseFloat($('#CLIENTWGHT').val()) || 0;
                
                console.log('Supplier:', supplierName, 'Client Weight:', clientWeight);
                
                // Populate transaction information
                $('#prod-supplier-name').text(supplierName);
                $('#prod-client-weight').text(clientWeight.toFixed(3));
                
                // Load production data with AJAX call to ensure fresh data
                loadProductionDataAndShow(clientWeight);
                
                console.log('Production Modal opened successfully');
            } catch (error) {
                console.error('Error opening production modal:', error);
                alert('Error opening production modal: ' + error.message);
            }
        }

        function populateProductionTable(clientWeight) {
            console.log('Populating production table with client weight:', clientWeight);
            
            var $tbody = $('#productionTableBody');
            $tbody.empty();
            
            var rowIndex = 1;
            var runningBalanceStock = clientWeight; // Start with client weight for cumulative calculation
            
            try {
                // Iterate through each transaction detail row
                $('#detailsTable tbody tr').each(function() {
                    var $row = $(this);
                    var trandid = $row.data('trandid') || 0;
                    
                    console.log('Processing row with TRANDID:', trandid);
                    
                    // Get product information from the row
                    var productType = $row.find('select.mgroup option:selected').text();
                    var product = $row.find('select.product option:selected').text();
                    
                    console.log('Product Type:', productType, 'Product:', product);
                    
                    // Skip if no product selected
                    if (!product || product === '-- Select Product --') {
                        console.log('Skipping row - no product selected');
                        return;
                    }
                    
                    // Calculate production quantity from all factory weights for this TRANDID
                    var productionQty = calculateProductionQuantity(trandid);
                    
                    // Get the latest date from product calculations for this TRANDID
                    var latestDate = getLatestProductionDate(trandid);
                    
                    // Calculate cumulative balance stock
                    // For first row: Client Weight - Production Quantity
                    // For subsequent rows: Previous Balance Stock - Current Production Quantity
                    var balanceStock = runningBalanceStock - productionQty;
                    
                    console.log('Row', rowIndex, '- Running Balance:', runningBalanceStock.toFixed(3), 'Production Qty:', productionQty.toFixed(3), 'New Balance Stock:', balanceStock.toFixed(3));
                    
                    // Create table row
                    var $tr = $('<tr></tr>');
                    $tr.append('<td class="text-center">' + rowIndex + '</td>');
                    $tr.append('<td>' + productType + '</td>');
                    $tr.append('<td>' + product + '</td>');
                    $tr.append('<td class="text-right">' + clientWeight.toFixed(3) + '</td>');
                    $tr.append('<td class="text-right">' + productionQty.toFixed(3) + '</td>');
                    $tr.append('<td class="text-right">' + balanceStock.toFixed(3) + '</td>');
                    $tr.append('<td class="text-center">' + (latestDate || 'N/A') + '</td>');
                    
                    $tbody.append($tr);
                    
                    // Update running balance for next iteration
                    runningBalanceStock = balanceStock;
                    rowIndex++;
                });
                
                // If no rows, show message
                if (rowIndex === 1) {
                    console.log('No transaction details found - showing empty message');
                    var $emptyRow = $('<tr><td colspan="7" class="text-center text-muted">No transaction details available</td></tr>');
                    $tbody.append($emptyRow);
                }
                
                console.log('Production table populated with', (rowIndex - 1), 'rows');
            } catch (error) {
                console.error('Error populating production table:', error);
                var $errorRow = $('<tr><td colspan="7" class="text-center text-danger">Error loading production data: ' + error.message + '</td></tr>');
                $tbody.append($errorRow);
            }
        }

        function loadProductionDataAndShow(clientWeight) {
            console.log('Loading production data with AJAX for consistent display...');
            
            // Show modal first with loading message
            $('#productionModal').modal('show');
            $('#productionTableBody').html('<tr><td colspan="7" class="text-center"><i class="fa fa-spinner fa-spin"></i> Loading production data...</td></tr>');
            
            // Get all transaction detail rows
            var trandIds = [];
            var rowCount = 0;
            $('#detailsTable tbody tr').each(function() {
                rowCount++;
                var trandid = $(this).data('trandid') || 0;
                console.log('Row', rowCount, '- TRANDID:', trandid);
                if (trandid > 0) {
                    trandIds.push(trandid);
                }
            });
            
            console.log('Total detail rows:', rowCount);
            console.log('Found TRANDIDs:', trandIds);
            
            if (trandIds.length === 0) {
                $('#productionTableBody').html('<tr><td colspan="7" class="text-center text-muted">No transaction details available</td></tr>');
                return;
            }
            
            // Load calculations for each TRANDID
            var allCalculations = {};
            var loadPromises = [];
            
            trandIds.forEach(function(trandid) {
                console.log('Loading calculations for TRANDID:', trandid);
                // Load calculations for all packing masters for this TRANDID
                @foreach (var packing in ViewBag.PackingMasters)
                {
                    <text>
                    console.log('Creating AJAX request for TRANDID', trandid, 'PackingID', @packing.Value);
                    var promise = $.ajax({
                        url: '@Url.Action("GetProductCalculation", "RawMaterialIntake")',
                        type: 'GET',
                        data: { trandid: trandid, packingId: @packing.Value },
                        dataType: 'json'
                    }).done(function(data) {
                        console.log('AJAX done for TRANDID', trandid, 'PackingID', @packing.Value, 'Response:', data);
                        if (data && data.success && data.calculation) {
                            var key = trandid + '_' + @packing.Value;
                            allCalculations[key] = data.calculation;
                            console.log('✓ Loaded calculation for TRANDID', trandid, 'PackingID', @packing.Value, 'FACTORYWGT:', data.calculation.FACTORYWGT);
                        } else {
                            console.log('✗ No calculation data in response for TRANDID', trandid, 'PackingID', @packing.Value);
                        }
                    }).fail(function(xhr, status, error) {
                        console.log('✗ AJAX failed for TRANDID', trandid, 'PackingID', @packing.Value, 'Status:', status, 'Error:', error);
                    });
                    loadPromises.push(promise);
                    </text>
                }
            });
            
            console.log('Total AJAX promises created:', loadPromises.length);
            
            // Wait for all AJAX calls to complete
            $.when.apply($, loadPromises).always(function() {
                console.log('All AJAX calls completed');
                console.log('Total calculations loaded:', Object.keys(allCalculations).length);
                console.log('All calculations:', allCalculations);
                populateProductionTableWithData(clientWeight, allCalculations);
            });
        }

        function populateProductionTableWithData(clientWeight, allCalculations) {
            console.log('Populating production table with loaded data...');
            
            var $tbody = $('#productionTableBody');
            $tbody.empty();
            
            var rowIndex = 1;
            var runningBalanceStock = clientWeight; // Start with client weight for cumulative calculation
            
            // Iterate through each transaction detail row
            $('#detailsTable tbody tr').each(function() {
                var $row = $(this);
                var trandid = $row.data('trandid') || 0;
                
                // Get product information from the row
                var productType = $row.find('select.mgroup option:selected').text();
                var product = $row.find('select.product option:selected').text();
                
                // Skip if no product selected
                if (!product || product === '-- Select Product --') {
                    return;
                }
                
                // Calculate production quantity from loaded calculations
                var productionQty = 0;
                var latestDate = null;
                
                for (var key in allCalculations) {
                    var calc = allCalculations[key];
                    if (calc && calc.TRANDID == trandid) {
                        var factoryWeight = parseFloat(calc.FACTORYWGT) || 0;
                        productionQty += factoryWeight;
                        
                        // Check for latest date
                        if (calc.PRODDATE) {
                            try {
                                var prodDate = new Date(calc.PRODDATE);
                                if (!isNaN(prodDate.getTime())) {
                                    if (!latestDate || prodDate > latestDate) {
                                        latestDate = prodDate;
                                    }
                                }
                            } catch (e) {
                                // Ignore invalid dates
                            }
                        }
                    }
                }
                
                // Calculate cumulative balance stock
                // For first row: Client Weight - Production Quantity
                // For subsequent rows: Previous Balance Stock - Current Production Quantity
                var balanceStock = runningBalanceStock - productionQty;
                var dateDisplay = latestDate ? latestDate.toLocaleDateString() : 'N/A';
                
                console.log('Row', rowIndex, '- TRANDID:', trandid, 'Running Balance:', runningBalanceStock.toFixed(3), 'Production Qty:', productionQty.toFixed(3), 'New Balance Stock:', balanceStock.toFixed(3), 'Date:', dateDisplay);
                
                // Create table row
                var $tr = $('<tr></tr>');
                $tr.append('<td class="text-center">' + rowIndex + '</td>');
                $tr.append('<td>' + productType + '</td>');
                $tr.append('<td>' + product + '</td>');
                $tr.append('<td class="text-right">' + clientWeight.toFixed(3) + '</td>');
                $tr.append('<td class="text-right">' + productionQty.toFixed(3) + '</td>');
                $tr.append('<td class="text-right">' + balanceStock.toFixed(3) + '</td>');
                $tr.append('<td class="text-center">' + dateDisplay + '</td>');
                
                $tbody.append($tr);
                
                // Update running balance for next iteration
                runningBalanceStock = balanceStock;
                rowIndex++;
            });
            
            // If no rows, show message
            if (rowIndex === 1) {
                var $emptyRow = $('<tr><td colspan="7" class="text-center text-muted">No transaction details available</td></tr>');
                $tbody.append($emptyRow);
            }
            
            console.log('Production table populated with', (rowIndex - 1), 'rows');
        }

        function calculateProductionQuantity(trandid) {
            var totalProduction = 0;
            
            console.log('=== Calculating Production Quantity for TRANDID:', trandid, '===');
            
            // Method 1: Check tab data first (most reliable for current session)
            $('.tab-pane').each(function() {
                var $tabPane = $(this);
                var storedCalculation = $tabPane.data('existing-calculation');
                var packingName = $tabPane.find('.nav-link').text() || $tabPane.attr('id') || 'Unknown';
                
                if (storedCalculation && storedCalculation.TRANDID == trandid) {
                    var factoryWeight = parseFloat(storedCalculation.FACTORYWGT) || 0;
                    if (factoryWeight > 0) {
                        totalProduction += factoryWeight;
                        console.log('- Found calculation from tab data for', packingName, '(TRANDID:', trandid, ') Factory Weight:', factoryWeight);
                    }
                }
            });
            
            // Method 2: If no tab data, check loaded calculations from database
            if (totalProduction === 0 && window.productionCalculations) {
                for (var key in window.productionCalculations) {
                    var calc = window.productionCalculations[key];
                    if (calc && calc.TRANDID == trandid) {
                        var factoryWeight = parseFloat(calc.FACTORYWGT) || 0;
                        if (factoryWeight > 0) {
                            totalProduction += factoryWeight;
                            console.log('- Found calculation from database for TRANDID', trandid, 'Factory Weight:', factoryWeight);
                        }
                    }
                }
            }
            
            // Method 3: Try to get from any visible calculation results on the page
            if (totalProduction === 0) {
                $('.factory-weight').each(function() {
                    var factoryWeightText = $(this).text();
                    var factoryWeight = parseFloat(factoryWeightText) || 0;
                    if (factoryWeight > 0) {
                        // Check if this belongs to our TRANDID (approximate check)
                        var $modal = $(this).closest('.modal');
                        if ($modal.length === 0 || $modal.is(':visible')) {
                            totalProduction += factoryWeight;
                            console.log('- Found factory weight from visible calculation:', factoryWeight);
                        }
                    }
                });
            }
            
            console.log('=== Total Production Quantity for TRANDID', trandid, ':', totalProduction, '===');
            return totalProduction;
        }

        // Helper function to format date as dd/MM/yyyy
        function formatDateToDDMMYYYY(date) {
            if (!date || isNaN(date.getTime())) return 'N/A';
            
            var day = String(date.getDate()).padStart(2, '0');
            var month = String(date.getMonth() + 1).padStart(2, '0');
            var year = date.getFullYear();
            
            return day + '/' + month + '/' + year;
        }

        function getLatestProductionDate(trandid) {
            var latestDate = null;
            
            console.log('Getting latest production date for TRANDID:', trandid);
            
            // Check loaded calculations from database
            if (window.productionCalculations) {
                for (var key in window.productionCalculations) {
                    var calc = window.productionCalculations[key];
                    if (calc && calc.TRANDID == trandid && calc.PRODDATE) {
                        try {
                            var prodDate = new Date(calc.PRODDATE);
                            if (!isNaN(prodDate.getTime())) { // Check if date is valid
                                if (!latestDate || prodDate > latestDate) {
                                    latestDate = prodDate;
                                }
                                console.log('Found valid date from database:', formatDateToDDMMYYYY(prodDate));
                            }
                        } catch (e) {
                            console.log('Invalid date from database:', calc.PRODDATE);
                        }
                    }
                }
            }
            
            // Also check tab data
            $('.tab-pane').each(function() {
                var $tabPane = $(this);
                var storedCalculation = $tabPane.data('existing-calculation');
                
                if (storedCalculation && storedCalculation.TRANDID === trandid && storedCalculation.PRODDATE) {
                    try {
                        var prodDate = new Date(storedCalculation.PRODDATE);
                        if (!isNaN(prodDate.getTime())) { // Check if date is valid
                            if (!latestDate || prodDate > latestDate) {
                                latestDate = prodDate;
                            }
                            console.log('Found valid date from tab data:', formatDateToDDMMYYYY(prodDate));
                        }
                    } catch (e) {
                        console.log('Invalid date from tab data:', storedCalculation.PRODDATE);
                    }
                }
            });
            
            var result = latestDate ? formatDateToDDMMYYYY(latestDate) : 'N/A';
            console.log('Latest production date result:', result);
            return result;
        }

        function refreshCalculationData() {
            console.log('Refreshing calculation data for production overview...');
            
            // Check if there are any existing calculations loaded in tabs
            var calculationsFound = 0;
            $('.tab-pane').each(function() {
                var $tabPane = $(this);
                var storedCalculation = $tabPane.data('existing-calculation');
                if (storedCalculation && storedCalculation.FACTORYWGT) {
                    calculationsFound++;
                    console.log('Found existing calculation in tab:', $tabPane.attr('id'), 'FACTORYWGT:', storedCalculation.FACTORYWGT);
                }
            });
            
            console.log('Total calculations found in tabs:', calculationsFound);
            
            // If no calculations in tabs, try to trigger loading from the existing functions
            if (calculationsFound === 0) {
                console.log('No calculations found in tabs, checking for existing data...');
                
                // Try to get data from any visible calculation displays
                $('.factory-weight').each(function() {
                    var factoryWeight = parseFloat($(this).text()) || 0;
                    if (factoryWeight > 0) {
                        console.log('Found factory weight in display:', factoryWeight);
                    }
                });
            }
        }

        function loadAllCalculationsForProduction(callback) {
            console.log('Loading all calculations for production overview...');
            
            // Initialize global calculations storage
            window.productionCalculations = {};
            
            var loadPromises = [];
            
            // Load calculations for each transaction detail row
            $('#detailsTable tbody tr').each(function() {
                var $row = $(this);
                var trandid = $row.data('trandid') || 0;
                
                if (trandid > 0) {
                    // Load calculations for all packing masters for this TRANDID
                    @foreach (var packing in ViewBag.PackingMasters)
                    {
                        <text>
                        var promise = $.ajax({
                            url: '@Url.Action("GetProductCalculation", "RawMaterialIntake")',
                            type: 'GET',
                            data: { trandid: trandid, packingId: @packing.Value },
                            dataType: 'json'
                        }).done(function(data) {
                            if (data && data.success && data.calculation) {
                                var key = trandid + '_' + @packing.Value;
                                window.productionCalculations[key] = data.calculation;
                                console.log('Loaded calculation for TRANDID', trandid, 'PackingID', @packing.Value, ':', data.calculation);
                            }
                        }).fail(function() {
                            console.log('No calculation found for TRANDID', trandid, 'PackingID', @packing.Value);
                        });
                        loadPromises.push(promise);
                        </text>
                    }
                }
            });
            
            // Wait for all calculations to load
            $.when.apply($, loadPromises).always(function() {
                console.log('All calculations loaded for production overview');
                if (callback) callback();
            });
        }
        
        
        // Active checkCalculationsExist function (outside commented section)
        function checkCalculationsExist(trandid, callback) {
            console.log('checkCalculationsExist called with trandid:', trandid);
            var hasCalculations = false;
            var checkPromises = [];
            var packingMasterCount = 0;
            
            // Check each packing master for calculations
            @foreach (var packing in ViewBag.PackingMasters)
            {
                <text>
                packingMasterCount++;
                console.log('Checking packing master:', @packing.Value, '@packing.Text');
                var promise = $.ajax({
                    url: '@Url.Action("GetProductCalculation", "RawMaterialIntake")',
                    type: 'GET',
                    data: { trandid: trandid, packingId: @packing.Value },
                    dataType: 'json'
                }).done(function(data) {
                    console.log('AJAX response for packing ID @packing.Value:', data);
                    if (data && data.success && data.calculation) {
                        hasCalculations = true;
                        console.log('Found calculation for packing ID:', @packing.Value, '@packing.Text');
                    } else {
                        console.log('No valid calculation data for packing ID:', @packing.Value, '@packing.Text');
                    }
                }).fail(function(xhr, status, error) {
                    console.log('AJAX failed for packing ID @packing.Value:', status, error);
                    console.log('Response:', xhr.responseText);
                });
                checkPromises.push(promise);
                </text>
            }
            
            console.log('Total packing masters to check:', packingMasterCount);
            console.log('Total promises created:', checkPromises.length);
            
            if (checkPromises.length === 0) {
                console.log('No packing masters found, calling callback with false');
                callback(false);
                return;
            }
            
            $.when.apply($, checkPromises).always(function() {
                console.log('All AJAX requests completed. Final hasCalculations:', hasCalculations);
                console.log('About to call callback with hasCalculations:', hasCalculations);
                callback(hasCalculations);
            });
        }
        
        // Direct PDF Generation Function for entire transaction (TRANMID)
        function generateDirectPDF(tranmid) {
            console.log('=== generateDirectPDF CALLED ===');
            console.log('Generating direct PDF for TRANMID:', tranmid);
            console.log('Type of tranmid:', typeof tranmid);
            
            if (!tranmid || tranmid <= 0) {
                console.error('Invalid TRANMID provided:', tranmid);
                alert('Invalid transaction ID. Cannot generate PDF.');
                return;
            }
            
            // Build PDF URL
            var pdfUrl = '@Url.Action("GenerateCalculationPDF", "RawMaterialIntake")' + '?tranmid=' + tranmid;
            console.log('PDF URL constructed:', pdfUrl);
            
            try {
                console.log('Attempting to open PDF window...');
                // Open PDF in new window/tab
                var pdfWindow = window.open(pdfUrl, '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
                
                if (pdfWindow) {
                    console.log('PDF window opened successfully');
                    // Focus on the new window
                    pdfWindow.focus();
                    
                    // Check if window was blocked after a short delay
                    setTimeout(function() {
                        if (pdfWindow.closed) {
                            console.log('PDF window was closed/blocked');
                            alert('PDF window was blocked. Please allow popups for this site to view the PDF report.');
                        } else {
                            console.log('PDF window is still open');
                        }
                    }, 1000);
                } else {
                    console.error('Failed to open PDF window - popup blocked');
                    alert('Please allow popups for this site to view the PDF report.');
                }
            } catch (error) {
                console.error('Exception in generateDirectPDF:', error);
                console.error('Error stack:', error.stack);
                alert('Error opening PDF: ' + error.message);
            }
            
            console.log('=== generateDirectPDF COMPLETED ===');
        }

        // Direct PDF Generation Function for specific row (TRANDID)
        function generateRowPDF(trandid) {
            console.log('=== generateRowPDF CALLED ===');
            console.log('Generating row PDF for TRANDID:', trandid);
            console.log('Type of trandid:', typeof trandid);
            
            if (!trandid || trandid <= 0) {
                console.error('Invalid TRANDID provided:', trandid);
                alert('Invalid transaction detail ID. Cannot generate PDF.');
                return;
            }
            
            // Build PDF URL for specific row
            var pdfUrl = '@Url.Action("GenerateRowCalculationPDF", "RawMaterialIntake")' + '?trandid=' + trandid;
            console.log('Row PDF URL constructed:', pdfUrl);
            
            try {
                console.log('Attempting to open row PDF window...');
                // Open PDF in new window/tab
                var pdfWindow = window.open(pdfUrl, '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
                
                if (pdfWindow) {
                    console.log('Row PDF window opened successfully');
                    // Focus on the new window
                    pdfWindow.focus();
                    
                    // Check if window was blocked after a short delay
                    setTimeout(function() {
                        if (pdfWindow.closed) {
                            console.log('Row PDF window was closed/blocked');
                            alert('PDF window was blocked. Please allow popups for this site to view the PDF report.');
                        } else {
                            console.log('Row PDF window is still open');
                        }
                    }, 1000);
                } else {
                    console.error('Failed to open row PDF window - popup blocked');
                    alert('Please allow popups for this site to view the PDF report.');
                }
            } catch (error) {
                console.error('Exception in generateRowPDF:', error);
                console.error('Error stack:', error.stack);
                alert('Error opening PDF: ' + error.message);
            }
            
            console.log('=== generateRowPDF COMPLETED ===');
        }
    </script>
}

<!-- Product Calculation Modal -->
<div class="modal fade" id="productCalculationModal" tabindex="-1" role="dialog" aria-labelledby="productCalculationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="productCalculationModalLabel">
                    <i class="fa fa-calculator"></i> Product Calculation
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close" style="opacity: 1; font-size: 1.5rem; font-weight: bold; text-shadow: 0 1px 0 rgba(0,0,0,0.5); background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); border-radius: 50%; width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease;">
                    <span aria-hidden="true" style="line-height: 1;">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- Display Information -->
                <div class="card mb-3">
                    <div class="card-header bg-light">
                        <h6 class="mb-0"><i class="fa fa-info-circle"></i> Transaction Information</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <strong>Supplier Name:</strong> <span id="modal-supplier-name"></span>
                            </div>
                            <div class="col-md-4">
                                <strong>Supplier Code:</strong> <span id="modal-supplier-code"></span>
                            </div>
                            <div class="col-md-4">
                                <strong>Product Type:</strong> <span id="modal-product-type"></span>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-md-4">
                                <strong>Product:</strong> <span id="modal-product"></span>
                            </div>
                            <div class="col-md-4">
                                <strong>No. of Boxes:</strong> <span id="modal-no-boxes"></span>
                            </div>
                            <div class="col-md-4">
                                <strong>Count (Per KG):</strong> <span id="modal-count-per-kg"></span>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-md-4">
                                <strong>Client Weight (KG):</strong> <span id="modal-client-weight"></span>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="gradeId" class="control-label"><strong>Grade <span class="text-danger">*</span> :</strong></label>
                                    @Html.DropDownList("GRADEID", ViewBag.Grades as List<SelectListItem>, new { @class = "form-control", id = "gradeId" })
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="colourId" class="control-label"><strong>Production Colour <span class="text-danger">*</span> :</strong></label>
                                    @Html.DropDownList("PCLRID", ViewBag.ProductionColours as List<SelectListItem>, new { @class = "form-control", id = "colourId" })
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="receivedTypeId" class="control-label"><strong>Received Type <span class="text-danger">*</span> :</strong></label>
                                    @Html.DropDownList("RCVDTID", ViewBag.ReceivedTypes as List<SelectListItem>, new { @class = "form-control", id = "receivedTypeId" })
                                </div>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="prodDate" class="control-label"><strong>Date <span class="text-danger">*</span> :</strong></label>
                                    <input type="date" class="form-control" id="prodDate" name="PRODDATE" />
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="facAvgWeight" class="control-label"><strong>Client Factory weight:</strong></label>
                                    <input type="number" class="form-control fac-avg-weight" id="facAvgWeight" step="0.001" min="0" placeholder="0.000" />
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="facAvgCount" class="control-label"><strong>Client Factory Count:</strong></label>
                                    <input type="number" class="form-control fac-avg-count" id="facAvgCount" step="0.001" min="0" placeholder="0.000" />
                                </div>
                            </div>
                        </div>
                        
                    </div>
                </div>

                <!-- Packing Master Navigation Tabs -->
                <div class="card mb-3">
                    <div class="card-header bg-light">
                        <h6 class="mb-0"><i class="fa fa-box"></i> Packing Master Selection</h6>
                    </div>
                    <div class="card-body p-0">
                        <ul class="nav nav-tabs" id="packingMasterTabs" role="tablist">
                            @{
                                var packingMasters = ViewBag.PackingMasters as List<SelectListItem> ?? new List<SelectListItem>();
                                // Order tabs so that "Head On" appears before "Head Less", others follow original order
                                Func<string, int> pmPriority = text =>
                                {
                                    var t = (text ?? "").ToLowerInvariant();
                                    if (t.Contains("head on")) return 0;
                                    if (t.Contains("head less") || t.Contains("headless")) return 1;
                                    return 2;
                                };
                                var packingMastersOrdered = packingMasters
                                    .OrderBy(pm => pmPriority(pm.Text))
                                    .ThenBy(pm => pm.Text)
                                    .ToList();
                                var isFirst = true;
                            }
                            @foreach (var packing in packingMastersOrdered)
                            {
                                <li class="nav-item" role="presentation">
                                    <a class="nav-link @(isFirst ? "active" : "")" 
                                       id="tab-@packing.Value" 
                                       data-bs-toggle="tab" 
                                       data-toggle="tab"
                                       href="#pane-@packing.Value" 
                                       role="tab" 
                                       aria-controls="pane-@packing.Value" 
                                       aria-selected="@(isFirst ? "true" : "false")"
                                       data-packing-id="@packing.Value"
                                       onclick="switchTab(@packing.Value)">
                                        <i class="fa fa-fish"></i>
                                        @packing.Text
                                    </a>
                                </li>
                                isFirst = false;
                            }
                        </ul>
                        
                        <!-- Calculation Mode Selection -->
                        <div class="calculation-mode-section">
                            <div class="card mb-3">
                                <div class="card-header bg-info text-white">
                                    <h6 class="mb-0"><i class="fa fa-cog"></i> Calculation Mode</h6>
                                </div>
                                <div class="card-body py-2">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="calculationMode" id="packingMode" value="packing" checked>
                                                <label class="form-check-label" for="packingMode">
                                                    <i class="fa fa-box"></i> <strong>Packing</strong>
                                                    <small class="text-muted d-block">Full calculation with all fields</small>
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="calculationMode" id="gradeWeightMode" value="gradeweight">
                                                <label class="form-check-label" for="gradeWeightMode">
                                                    <i class="fa fa-weight"></i> <strong>Grade Weight</strong>
                                                    <small class="text-muted d-block">Simple: Slab + Peeled only</small>
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="tab-content" id="packingMasterTabContent">
                            @{
                                isFirst = true;
                            }
                            @foreach (var packing in packingMastersOrdered)
                            {
                                <div class="tab-pane fade @(isFirst ? "show active" : "")" 
                                     id="pane-@packing.Value" 
                                     role="tabpanel" 
                                     aria-labelledby="tab-@packing.Value"
                                     data-packing-id="@packing.Value">
                                     
                                    <!-- Single Form for this Packing Master -->
                                    <div class="p-3">
                                        <h6 class="mb-3">@packing.Text Calculation</h6>
                                        
                                        <!-- Dynamic Packing Type Fields -->
                                        <div class="card mb-3">
                                            <div class="card-header bg-light">
                                                <h6 class="mb-0"><i class="fa fa-cubes"></i> Packing Type Details</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="packing-fields-container row" data-packing-id="@packing.Value">
                                                    <!-- Dynamic fields will be loaded here -->
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Calculations Section -->
                                        <div class="row" id="calculations-section">
                                            <!-- Slab Calculation -->
                                            <div class="col-md-6" id="slab-calculation-section">
                                                <div class="card">
                                                    <div class="card-header bg-success text-white">
                                                        <h6 class="mb-0"><i class="fa fa-calculator"></i> Slab Calculation</h6>
                                                    </div>
                                                    <div class="card-body">
                                                        <div class="form-group" id="slab-field">
                                                            <label>Slab:</label>
                                                            <div class="alert alert-info">
                                                                <strong class="total-counts">0</strong>
                                                            </div>
                                                        </div>
                                                        <div class="form-group slab-field" id="avg-pack-value-field">
                                                            <label>Average Pack Value:</label>
                                                            <div class="alert alert-info">
                                                                <strong class="avg-pack-value calculation-result">0.000</strong>
                                                            </div>
                                                        </div>
                                                        <div class="form-group slab-field" id="pounds-value-field">
                                                            <label for="poundsValue_@packing.Value">Pounds Conversion:</label>
                                                            <input type="number" class="form-control pounds-value" id="poundsValue_@packing.Value" step="0.001" min="0">
                                                        </div>
                                                        <div class="form-group slab-field" id="total-pounds-field">
                                                            <label>Total Pounds:</label>
                                                            <div class="alert alert-info">
                                                                <strong class="total-pounds calculation-result">0.000</strong>
                                                            </div>
                                                        </div>
                                                        <div class="form-group slab-field" id="yield-percent-field">
                                                            <label for="yieldPercent_@packing.Value">Yield Percent (%):</label>
                                                            <input type="number" class="form-control yield-percent" id="yieldPercent_@packing.Value" step="0.001" min="0" max="100">
                                                        </div>
                                                        <div class="form-group slab-field" id="total-yield-counts-field">
                                                            <label>Total Yield Counts:</label>
                                                            <div class="alert alert-success">
                                                                <strong class="total-yield-counts calculation-result">0.000</strong>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Total Weight Calculation -->
                                            <div class="col-md-6" id="total-weight-calculation-section">
                                                <div class="card">
                                                    <div class="card-header bg-warning text-dark">
                                                        <h6 class="mb-0"><i class="fa fa-weight"></i> Total Weight Calculation</h6>
                                                    </div>
                                                    <div class="card-body">
                                                        <div class="form-group weight-field" id="per-kg-weight-field">
                                                            <label for="perKgWeight_@packing.Value">Packing Weight with Glazing:</label>
                                                            <input type="number" class="form-control per-kg-weight" id="perKgWeight_@packing.Value" step="0.001" min="0">
                                                        </div>
                                                        <div class="form-group weight-field" id="pack-kg-weight-field">
                                                            <label>Pack KG Weight:</label>
                                                            <div class="alert alert-info">
                                                                <strong class="pck-kg-weight calculation-result">0.000</strong>
                                                            </div>
                                                        </div>
                                                        <div class="form-group" id="peeled-field">
                                                            <label for="wastage_@packing.Value">Peeled:</label>
                                                            <input type="number" class="form-control wastage" id="wastage_@packing.Value" step="0.001" min="0">
                                                        </div>
                                                        <div class="form-group weight-field" id="waste-weight-field">
                                                            <label>Peeled + Weight:</label>
                                                            <div class="alert alert-info">
                                                                <strong class="waste-p-weight calculation-result">0.000</strong>
                                                            </div>
                                                        </div>
                                                    <div class="form-group weight-field" id="factory-weight-field">
                                                        <label>Factory Weight:</label>
                                                        <div class="alert alert-warning">
                                                            <strong class="factory-weight calculation-result">0.000</strong>
                                                        </div>
                                                    </div>

                                                    
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Save Button for this tab -->
                                        <div class="text-center mt-3">
                                            <button type="button" class="btn btn-outline-secondary mr-2 back-tab-btn" data-packing-id="@packing.Value">
                                                <i class="fa fa-arrow-left"></i> Back
                                            </button>
                                            <button type="button" class="btn btn-primary save-tab-calculation-btn" data-packing-id="@packing.Value">
                                                <i class="fa fa-save"></i> Save @packing.Text Calculation
                                            </button>
                                            <button type="button" class="btn btn-secondary ml-2 next-tab-btn" data-packing-id="@packing.Value">
                                                <i class="fa fa-arrow-right"></i> Next
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                isFirst = false;
                            }
                        </div>
                    </div>
                </div>

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeProductCalculationModal()">
                    <i class="fa fa-times"></i> Close
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Production Modal -->
<div class="modal fade" id="productionModal" tabindex="-1" role="dialog" aria-labelledby="productionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="productionModalLabel">
                    <i class="fa fa-industry"></i> Production Overview
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close" style="opacity: 1; font-size: 1.5rem; font-weight: bold; text-shadow: 0 1px 0 rgba(0,0,0,0.5); background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); border-radius: 50%; width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease;">
                    <span aria-hidden="true" style="line-height: 1;">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="card">
                    <div class="card-header bg-light">
                        <h6 class="mb-0"><i class="fa fa-info-circle"></i> Transaction Information</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <strong>Supplier:</strong> <span id="prod-supplier-name"></span>
                            </div>
                            <div class="col-md-6">
                                <strong>Client Weight:</strong> <span id="prod-client-weight"></span> KG
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mt-3">
                    <div class="card-header bg-light">
                        <h6 class="mb-0"><i class="fa fa-table"></i> Production Details</h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered table-striped" id="productionTable">
                                <thead class="thead-dark">
                                    <tr>
                                        <th>S.No</th>
                                        <th>Product Type</th>
                                        <th>Product</th>
                                        <th>Client Weight (KG)</th>
                                        <th>Production Quantity (KG)</th>
                                        <th>Balance Stock (KG)</th>
                                        <th>Date</th>
                                    </tr>
                                </thead>
                                <tbody id="productionTableBody">
                                    <!-- Production rows will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                    <i class="fa fa-times"></i> Close
                </button>
            </div>
        </div>
    </div>
</div>

